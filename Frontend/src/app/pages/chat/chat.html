<mat-sidenav-container class="shell">

  <!-- LEFT: Private chats -->
  <mat-sidenav mode="side" opened class="leftPane">
    <mat-toolbar color="primary" class="paneHeader">Private</mat-toolbar>

    <mat-nav-list>
      <a mat-list-item *ngFor="let u of users" [class.active]="u === selectedUser" (click)="openChat(u)">
        <mat-icon matListItemIcon>person</mat-icon>
        <div matListItemTitle>{{ u }}</div>
        <div matListItemLine>{{ lastText(u) }}</div>
        <span class="unreadBadge" *ngIf="unreadCount(u) > 0">{{ unreadCount(u) }}</span>
        <button mat-icon-button color="warn" (click)="$event.stopPropagation(); removePrivateChat(u)" matTooltip="Remove chat">
          <mat-icon>delete</mat-icon>
        </button>
      </a>
    </mat-nav-list>
  </mat-sidenav>

  <!-- CENTER: Chat area -->
  <mat-sidenav-content class="centerPane">
    <mat-toolbar color="primary" class="paneHeader">
      <ng-container *ngIf="!selectedUser; else privateHeader">
        <span>Public Room</span>
        <span class="typingHint" *ngIf="typingPublicList.length">â€¢ {{ publicTypingText }}</span>
      </ng-container>
      <ng-template #privateHeader>
        <button mat-icon-button (click)="backToPublic()" matTooltip="Back to public">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span>Chat with {{ selectedUser }}</span>
        <span class="typingHint" *ngIf="selectedUser && isTypingMap[selectedUser]">â€¢ typing...</span>
      </ng-template>
      <span class="flex-spacer"></span>
      <button mat-icon-button class="searchToggleBtn" matTooltip="Search in this room" (click)="toggleSearch()">
        <mat-icon>{{ searchOpen ? 'close' : 'search' }}</mat-icon>
      </button>
      <button mat-icon-button matTooltip="Sign out" (click)="signOut()">
        <mat-icon>logout</mat-icon>
      </button>
    </mat-toolbar>

    <div class="searchPopover" *ngIf="searchOpen">
      <div class="toolbarSearch">
        <mat-icon>search</mat-icon>
        <input
          #searchInput
          type="text"
          [(ngModel)]="messageSearchQuery"
          (input)="onMessageSearchInput()"
          placeholder="Search in this room"
        />
        <button mat-icon-button type="button" *ngIf="messageSearchQuery" (click)="clearMessageSearch()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="searchContext">{{ currentSearchContextLabel() }}</div>

      <div class="searchPanel" *ngIf="messageSearchQuery.trim().length >= 2">
        <div class="searchState" *ngIf="searchingMessages">Searching...</div>
        <div class="searchState" *ngIf="!searchingMessages && !searchResults.length">No messages found</div>
        <button class="searchResult" type="button" *ngFor="let r of searchResults" (click)="openSearchResult(r)">
          <div class="searchText" [innerHTML]="highlightText(r.text)"></div>
          <div class="searchMeta">{{ r.from }} â€¢ {{ r.timestamp | date:'short' }}</div>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div class="messages">
      <ng-container *ngIf="!selectedUser; else privateView">
        <button
          class="loadOlderBtn"
          mat-stroked-button
          type="button"
          *ngIf="publicHasMore"
          [disabled]="publicLoading"
          (click)="loadOlderPublicMessages()"
        >
          {{ publicLoading ? 'Loading...' : 'Load older messages' }}
        </button>

        <div class="msg" *ngFor="let m of publicMessages" [class.me]="m.from === myUsername">
          <button mat-button class="userBtn"
                  [matMenuTriggerFor]="userMenu"
                  (click)="$event.stopPropagation(); menuUser=m.from">
            <mat-icon>account_circle</mat-icon>
            <span>{{ m.from }}</span>
          </button>
          <mat-card
            class="bubble"
            [attr.data-msg-id]="m.id"
            [class.is-editing]="isEditingMessage(m, 'public')"
            [class.is-deleting]="isPendingDelete(m)"
            [class.was-edited]="isRecentlyEdited(m)"
            (mousedown)="startReactionPress(m, 'public', $event)"
            (mouseup)="cancelReactionPress()"
            (mouseleave)="cancelReactionPress()"
            (touchstart)="startReactionPress(m, 'public', $event)"
            (touchend)="cancelReactionPress()"
            (touchcancel)="cancelReactionPress()"
          >
            <div class="editInline" *ngIf="isEditingMessage(m, 'public'); else publicTextView">
              <input
                class="editInlineInput"
                [(ngModel)]="editingMessage!.text"
                maxlength="500"
                (keydown.enter)="saveMessageEdit(m, 'public')"
                (keydown.escape)="cancelMessageEdit()"
              />
              <div class="editInlineActions">
                <button class="iconMini" type="button" (click)="cancelMessageEdit()" matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
                <button class="iconMini primary" type="button" (click)="saveMessageEdit(m, 'public')" matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
              </div>
            </div>
            <ng-template #publicTextView>
              <div class="text" [class.deletedText]="m.deletedAt" [innerHTML]="m.deletedAt ? 'Message deleted' : highlightText(m.text)"></div>
            </ng-template>
            <div class="meta">
              <div class="messageActions" *ngIf="canManageMessage(m) && !isEditingMessage(m, 'public')">
                <button class="actionBtn" type="button" *ngIf="canEditMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); editMessage(m, 'public')" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="actionBtn danger" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); deleteMessage(m, 'public')" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="metaInfo">
                <span class="editedTag" *ngIf="m.editedAt && !m.deletedAt">edited</span>
                <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
              </div>
            </div>
            <div class="reactionsSummary" *ngIf="visibleReactions(m).length">
              <span class="reactionPill" *ngFor="let r of visibleReactions(m)">
                {{ r.emoji }} {{ r.users.length }}
              </span>
            </div>
            <div class="reactionPicker" *ngIf="isReactionPickerOpen(m, 'public')" (click)="$event.stopPropagation()">
              <button
                class="reactionOption"
                type="button"
                *ngFor="let emoji of messageReactions"
                [class.active]="hasReactionByMe(m, emoji)"
                (click)="toggleReaction(m, 'public', emoji)"
              >
                {{ emoji }}
                <span *ngIf="reactionCount(m, emoji)">{{ reactionCount(m, emoji) }}</span>
              </button>
            </div>
          </mat-card>
        </div>
      </ng-container>

      <ng-template #privateView>
        <div class="msg" *ngFor="let m of currentThread()" [class.me]="m.from === myUsername">
          <mat-card
            class="bubble"
            [attr.data-msg-id]="m.id"
            [class.is-editing]="isEditingMessage(m, 'private')"
            [class.is-deleting]="isPendingDelete(m)"
            [class.was-edited]="isRecentlyEdited(m)"
            (mousedown)="startReactionPress(m, 'private', $event)"
            (mouseup)="cancelReactionPress()"
            (mouseleave)="cancelReactionPress()"
            (touchstart)="startReactionPress(m, 'private', $event)"
            (touchend)="cancelReactionPress()"
            (touchcancel)="cancelReactionPress()"
          >
            <div class="editInline" *ngIf="isEditingMessage(m, 'private'); else privateTextView">
              <input
                class="editInlineInput"
                [(ngModel)]="editingMessage!.text"
                maxlength="500"
                (keydown.enter)="saveMessageEdit(m, 'private')"
                (keydown.escape)="cancelMessageEdit()"
              />
              <div class="editInlineActions">
                <button class="iconMini" type="button" (click)="cancelMessageEdit()" matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
                <button class="iconMini primary" type="button" (click)="saveMessageEdit(m, 'private')" matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
              </div>
            </div>
            <ng-template #privateTextView>
              <div class="text" [class.deletedText]="m.deletedAt" [innerHTML]="m.deletedAt ? 'Message deleted' : highlightText(m.text)"></div>
            </ng-template>
            <div class="meta">
              <div class="messageActions" *ngIf="canManageMessage(m) && !isEditingMessage(m, 'private')">
                <button class="actionBtn" type="button" *ngIf="canEditMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); editMessage(m, 'private')" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="actionBtn danger" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); deleteMessage(m, 'private')" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="metaInfo">
                <span class="editedTag" *ngIf="m.editedAt && !m.deletedAt">edited</span>
                <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
                <mat-icon *ngIf="m.from === myUsername" class="status-icon"
                          [ngClass]="m.status">
                  {{ m.status === 'sent' ? 'done' : 'done_all' }}
                </mat-icon>
              </div>
            </div>
            <div class="reactionsSummary" *ngIf="visibleReactions(m).length">
              <span class="reactionPill" *ngFor="let r of visibleReactions(m)">
                {{ r.emoji }} {{ r.users.length }}
              </span>
            </div>
            <div class="reactionPicker" *ngIf="isReactionPickerOpen(m, 'private')" (click)="$event.stopPropagation()">
              <button
                class="reactionOption"
                type="button"
                *ngFor="let emoji of messageReactions"
                [class.active]="hasReactionByMe(m, emoji)"
                (click)="toggleReaction(m, 'private', emoji)"
              >
                {{ emoji }}
                <span *ngIf="reactionCount(m, emoji)">{{ reactionCount(m, emoji) }}</span>
              </button>
            </div>
          </mat-card>
        </div>
      </ng-template>
    </div>

    <!-- Menu for public usernames -->
    <mat-menu #userMenu="matMenu">
      <button mat-menu-item (click)="startChatFromPublic(menuUser)">
        <mat-icon>chat</mat-icon>
        <span>Message privately</span>
      </button>
    </mat-menu>

    <!-- Composer -->
    <form class="composer" (ngSubmit)="selectedUser ? sendPrivate() : sendPublic()">
      <div class="composerFieldWrap">
        <mat-form-field appearance="outline" class="composerInput">
          <mat-label>{{ selectedUser ? 'Type a private message' : 'Type a public message' }}</mat-label>
          <input
            matInput
            [(ngModel)]="message"
            name="msg"
            autocomplete="off"
            (input)="selectedUser ? onPrivateInput() : onPublicInput()"
            (blur)="onInputBlur()"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="emojiTrigger"
            aria-label="Open emoji picker"
            (click)="toggleEmojiPicker(); $event.stopPropagation()"
          >
            ðŸ™‚
          </button>
        </mat-form-field>
        <div class="emojiPicker" *ngIf="showEmojiPicker" (click)="$event.stopPropagation()">
          <button class="emojiBtn" type="button" *ngFor="let emoji of composerEmojis" (click)="addEmoji(emoji)">
            {{ emoji }}
          </button>
        </div>
      </div>
      <button mat-raised-button color="primary" type="submit">Send</button>
    </form>
  </mat-sidenav-content>

  <!-- RIGHT: Online users -->
  <mat-sidenav mode="side" opened position="end" class="rightPane">
    <mat-toolbar color="primary" class="paneHeader">
      Online ({{ filteredOnlineUsers.length }})
      <span class="flex-spacer"></span>
      <button mat-icon-button (click)="openAddUserDialog()" matTooltip="Start chat with any user">
        <mat-icon>add</mat-icon>
      </button>
    </mat-toolbar>

    <div class="rightBody">
      <mat-form-field appearance="outline" class="w100">
        <mat-label>Search online users</mat-label>
        <input matInput [(ngModel)]="searchTerm" (input)="applyFilter()" />
      </mat-form-field>

      <mat-nav-list *ngIf="filteredOnlineUsers.length; else nobody">
        <a mat-list-item *ngFor="let u of filteredOnlineUsers" (click)="openDmFromSidebar(u)">
          <mat-icon matListItemIcon>circle</mat-icon>
          <div matListItemTitle>{{ u }}</div>
          <div matListItemLine>Click to DM</div>
        </a>
      </mat-nav-list>

      <ng-template #nobody>
        <p class="muted">No matching online users.</p>
      </ng-template>
    </div>
  </mat-sidenav>
</mat-sidenav-container>

<!-- Add user dialog -->
<ng-template #startChatTpl let-dialogRef="dialogRef">
  <div class="dialogBody">
    <h3>Start a Private Chat</h3>

    <mat-form-field appearance="outline" class="w100">
      <mat-label>Username</mat-label>
      <input matInput [(ngModel)]="newUser" />
    </mat-form-field>

    <div class="dialogActions">
      <button mat-stroked-button (click)="dialogRef.close()">Cancel</button>
      <button mat-flat-button color="primary" (click)="startChatConfirm(dialogRef)">Start</button>
    </div>
  </div>
</ng-template>

<ng-template #confirmDeleteTpl let-dialogRef="dialogRef">
  <div class="confirmDeleteBody">
    <div class="confirmDeleteIconWrap">
      <mat-icon>delete_forever</mat-icon>
    </div>
    <h3>Delete message?</h3>
    <p>This action cannot be undone.</p>
    <div class="confirmDeletePreview" *ngIf="deleteCandidate?.preview">
      {{ deleteCandidate?.preview }}
    </div>
    <div class="confirmDeleteActions">
      <button mat-stroked-button type="button" (click)="dialogRef.close(false)">Cancel</button>
      <button mat-flat-button color="warn" type="button" (click)="dialogRef.close(true)">Delete</button>
    </div>
  </div>
</ng-template>
