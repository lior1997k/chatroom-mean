<mat-sidenav-container class="shell">

  <!-- LEFT: Private chats -->
  <mat-sidenav mode="side" opened class="leftPane">
    <mat-toolbar color="primary" class="paneHeader">Private</mat-toolbar>

    <mat-nav-list>
      <a mat-list-item *ngFor="let u of users" [class.active]="u === selectedUser">
        <mat-icon matListItemIcon>person</mat-icon>
        <div matListItemTitle (click)="openChat(u)">{{ u }}</div>
        <div matListItemLine>{{ lastText(u) }}</div>
        <button mat-icon-button color="warn" (click)="removePrivateChat(u)" matTooltip="Remove chat">
          <mat-icon>delete</mat-icon>
        </button>
      </a>
    </mat-nav-list>
  </mat-sidenav>

  <!-- CENTER: Chat area -->
  <mat-sidenav-content class="centerPane">
    <mat-toolbar color="primary" class="paneHeader">
      <ng-container *ngIf="!selectedUser; else privateHeader">
        <span>Public Room</span>
        <span class="typingHint" *ngIf="typingPublicList.length">
          •
          <ng-container *ngFor="let u of typingPublicList; let last = last">
            {{ u }}<span *ngIf="!last">, </span>
          </ng-container>
          is typing…
        </span>
      </ng-container>
      <ng-template #privateHeader>
        <button mat-icon-button (click)="backToPublic()" matTooltip="Back to public">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <span>Chat with {{ selectedUser }}</span>
        <span class="typingHint" *ngIf="selectedUser && isTypingMap[selectedUser]">• typing…</span>
      </ng-template>
    </mat-toolbar>

    <!-- Messages -->
    <div class="messages">
      <!-- PUBLIC VIEW -->
      <ng-container *ngIf="!selectedUser; else privateView">
        <div class="msg" *ngFor="let m of publicMessages" [class.me]="m.from === myUsername">
          <button mat-button class="userBtn"
                  [matMenuTriggerFor]="userMenu"
                  (click)="$event.stopPropagation(); menuUser=m.from">
            <mat-icon>account_circle</mat-icon>
            <span>{{ m.from }}</span>
          </button>

          <mat-card class="bubble">
            <ng-container [ngSwitch]="m.kind">
              <ng-container *ngSwitchCase="'voice'">
                <div class="voice-row">
                  <mat-icon>graphic_eq</mat-icon>
                  <audio [src]="m.mediaUrl" controls preload="metadata"></audio>
                  <span class="time" *ngIf="m.durationMs">{{ (m.durationMs/1000) | number:'1.0-1' }}s</span>
                </div>
                <div class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</div>
              </ng-container>

              <ng-container *ngSwitchDefault>
                <div class="text">{{ m.text }}</div>
                <div class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</div>
              </ng-container>
            </ng-container>
          </mat-card>
        </div>
      </ng-container>

      <!-- PRIVATE VIEW -->
      <ng-template #privateView>
        <div class="msg" *ngFor="let m of currentThread()" [class.me]="m.from === myUsername">
          <mat-card class="bubble">
            <ng-container [ngSwitch]="m.kind">
              <ng-container *ngSwitchCase="'voice'">
                <div class="voice-row">
                  <mat-icon>graphic_eq</mat-icon>
                  <audio [src]="m.mediaUrl" controls preload="metadata"></audio>
                  <span class="time" *ngIf="m.durationMs">{{ (m.durationMs/1000) | number:'1.0-1' }}s</span>
                </div>
                <div class="meta">
                  <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
                  <mat-icon *ngIf="m.from === myUsername" class="status-icon" [ngClass]="m.status">
                    {{ m.status === 'sent' ? 'done' : 'done_all' }}
                  </mat-icon>
                </div>
              </ng-container>

              <ng-container *ngSwitchDefault>
                <div class="text">{{ m.text }}</div>
                <div class="meta">
                  <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
                  <mat-icon *ngIf="m.from === myUsername" class="status-icon" [ngClass]="m.status">
                    {{ m.status === 'sent' ? 'done' : 'done_all' }}
                  </mat-icon>
                </div>
              </ng-container>
            </ng-container>
          </mat-card>
        </div>
      </ng-template>
    </div>

    <!-- Menu for public usernames -->
    <mat-menu #userMenu="matMenu">
      <button mat-menu-item (click)="startChatFromPublic(menuUser)">
        <mat-icon>chat</mat-icon>
        <span>Message privately</span>
      </button>
    </mat-menu>

    <!-- Composer -->
    <form class="composer" (ngSubmit)="selectedUser ? sendPrivate() : sendPublic()">
      <mat-form-field appearance="outline" class="composerInput">
        <mat-label>{{ selectedUser ? 'Type a private message' : 'Type a public message' }}</mat-label>
        <input
          matInput
          [(ngModel)]="message"
          name="msg"
          autocomplete="off"
          (input)="selectedUser ? onPrivateInput() : onPublicInput()"
          (blur)="onInputBlur()"
          [disabled]="isRecording"
        />
      </mat-form-field>

      <!-- Mic: click to start/stop. Dialog handles preview -->
      <button
        mat-icon-button
        type="button"
        [color]="isRecording ? 'warn' : undefined"
        (click)="toggleRecording()"
        matTooltip="{{ isRecording ? 'Tap to stop' : 'Tap to record voice' }}"
      >
        <mat-icon>{{ isRecording ? 'stop_circle' : 'mic' }}</mat-icon>
      </button>

      <button mat-raised-button color="primary" type="submit" [disabled]="isRecording">
        Send
      </button>
    </form>
  </mat-sidenav-content>

  <!-- RIGHT: Online users -->
  <mat-sidenav mode="side" opened position="end" class="rightPane">
    <mat-toolbar color="primary" class="paneHeader">
      Online ({{ filteredOnlineUsers.length }})
      <span class="flex-spacer"></span>
      <button mat-icon-button (click)="openAddUserDialog()" matTooltip="Start chat with any user">
        <mat-icon>add</mat-icon>
      </button>
    </mat-toolbar>

    <div class="rightBody">
      <mat-form-field appearance="outline" class="w100">
        <mat-label>Search online users</mat-label>
        <input matInput [(ngModel)]="searchTerm" (input)="applyFilter()" />
      </mat-form-field>

      <mat-nav-list *ngIf="filteredOnlineUsers.length; else nobody">
        <a mat-list-item *ngFor="let u of filteredOnlineUsers" (click)="openDmFromSidebar(u)">
          <mat-icon matListItemIcon>circle</mat-icon>
          <div matListItemTitle>{{ u }}</div>
          <div matListItemLine>Click to DM</div>
        </a>
      </mat-nav-list>

      <ng-template #nobody>
        <p class="muted">No matching online users.</p>
      </ng-template>
    </div>
  </mat-sidenav>
</mat-sidenav-container>

<!-- Add user dialog -->
<ng-template #startChatTpl let-dialogRef="dialogRef">
  <div class="dialogBody">
    <h3>Start a Private Chat</h3>

    <mat-form-field appearance="outline" class="w100">
      <mat-label>Username</mat-label>
      <input matInput [(ngModel)]="newUser" />
    </mat-form-field>

    <div class="dialogActions">
      <button mat-stroked-button (click)="dialogRef.close()">Cancel</button>
      <button mat-flat-button color="primary" (click)="dialogRef.close(newUser)">Start</button>
    </div>
  </div>
</ng-template>

<!-- Voice preview dialog -->
<ng-template #voicePreviewTpl>
  <div class="dialogBody voice-preview">
    <h3>Voice message</h3>
    <div class="voice-row">
      <mat-icon>play_circle</mat-icon>
      <audio [src]="previewUrl!" controls></audio>
      <span class="time">{{ (previewDurationMs/1000) | number:'1.0-1' }}s</span>
    </div>

    <div class="dialogActions">
      <button mat-stroked-button color="primary" (click)="sendRecorded()">
        <mat-icon>send</mat-icon>
        Send
      </button>
      <button mat-stroked-button color="warn" (click)="cancelRecording()">
        <mat-icon>delete</mat-icon>
        Delete
      </button>
      <button mat-stroked-button (click)="rerecord()">
        <mat-icon>mic</mat-icon>
        Re-record
      </button>
    </div>
  </div>
</ng-template>
