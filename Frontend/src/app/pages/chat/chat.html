<mat-sidenav-container class="shell" [autosize]="isMobileView">

  <!-- LEFT: Private chats -->
  <mat-sidenav #leftSidenav [mode]="leftPaneMode" [(opened)]="leftPaneOpened" class="leftPane">
    <div class="paneHeader">
      <span class="paneTitle">Messages</span>
      <span class="onlineCount" *ngIf="onlineUserCount() > 0">{{ onlineUserCount() }} online</span>
    </div>

    <div class="privateChatsList">
      <div class="chatItem" *ngFor="let u of users" [class.active]="u === selectedUser" (click)="openChat(u)">
        <div class="chatAvatar">
          <img *ngIf="avatarUrl(u); else fallbackUserIcon" [src]="avatarUrl(u)" alt="avatar" (click)="$event.stopPropagation(); openUserProfileCard(u)" />
          <ng-template #fallbackUserIcon>
            <div class="avatarFallback" (click)="$event.stopPropagation(); openUserProfileCard(u)">
              <mat-icon>person</mat-icon>
            </div>
          </ng-template>
          <span class="onlineDot" *ngIf="isUserOnline(u)"></span>
        </div>
        <div class="chatContent">
          <div class="chatHeader">
            <span class="chatName">{{ userDisplayName(u) }}</span>
            <span class="chatTime">{{ lastMessageTime(u) }}</span>
          </div>
          <div class="chatPreview">
            <span *ngIf="draftPreview(u)" class="draftLabel">Draft:</span>
            {{ draftPreview(u) || lastText(u) }}
          </div>
        </div>
        <div class="chatMeta">
          <span class="unreadBadge" *ngIf="unreadCount(u) > 0">{{ unreadCount(u) }}</span>
          <button class="deleteChatBtn" (click)="$event.stopPropagation(); removePrivateChat(u)" matTooltip="Remove chat">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
      <div class="emptyState" *ngIf="!users?.length">
        <mat-icon>chat_bubble_outline</mat-icon>
        <p>No conversations yet</p>
        <span>Start a chat from the users panel</span>
      </div>
    </div>
  </mat-sidenav>


  <!-- CENTER: Chat area -->
  <mat-sidenav-content
    class="centerPane"
    (dragenter)="onComposerDragEnter($event)"
    (dragover)="onComposerDragOver($event)"
    (dragleave)="onComposerDragLeave($event)"
    (drop)="onComposerDrop($event)"
  >
    <mat-toolbar color="primary" class="paneHeader">
      <button mat-icon-button class="mobileNavBtn" *ngIf="isMobileView" (click)="toggleMobileChats()" matTooltip="Conversations">
        <mat-icon>menu</mat-icon>
      </button>
      <ng-container *ngIf="!selectedUser; else privateHeader">
        <span class="roomTitle">Public Room</span>
        <span class="typingHint" *ngIf="typingPublicList.length">• {{ publicTypingText }}</span>
      </ng-container>
      <ng-template #privateHeader>
        <button mat-icon-button (click)="backToPublic()" matTooltip="Back to public">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <button
          mat-button
          type="button"
          (click)="togglePrivateMediaTimeline()"
          style="padding: 0 8px; min-width: 0; height: 32px; line-height: 32px; border-radius: 8px; font-weight: 600; color: #203a56; background: rgba(255,255,255,0.22);"
          matTooltip="Toggle private media timeline"
        >
          Chat with {{ selectedUser }}
        </button>
        <span class="typingHint" *ngIf="selectedUser && isTypingMap[selectedUser]">• typing...</span>
        <button
          mat-stroked-button
          type="button"
          *ngIf="hasUnreadMarker()"
          style="margin-left: 10px; height: 28px; line-height: 26px;"
          (click)="jumpToFirstUnread()"
        >
          First unread
        </button>
      </ng-template>
      <span class="flex-spacer"></span>
      <div class="searchShell">
        <button
          mat-icon-button
          class="searchIconBtn"
          *ngIf="!searchOpen"
          aria-label="Open search"
          matTooltip="Search in this room"
          (mousedown)="$event.stopPropagation()"
          (click)="$event.stopPropagation(); toggleSearch()"
        >
          <mat-icon>search</mat-icon>
        </button>

        <div class="toolbarSearch" *ngIf="searchOpen" style="gap: 6px; border-radius: 12px; min-height: 38px; padding: 3px 6px 3px 10px; width: min(460px, 56vw); background: linear-gradient(180deg, #ffffff, #f7faff); border-color: #c9d8eb; box-shadow: 0 1px 0 rgba(255,255,255,0.8), 0 2px 8px rgba(30,56,89,0.08); flex-wrap: nowrap; overflow: hidden;">
          <mat-icon style="color: #4f6580; font-size: 20px; width: 20px; height: 20px;">search</mat-icon>
          <input
            #searchInput
            type="text"
            [(ngModel)]="searchInputText"
            (ngModelChange)="onSearchTextInput($event)"
            (keydown.enter)="nextSearchMatch()"
            placeholder="Search messages"
            spellcheck="false"
            autocapitalize="off"
            autocorrect="off"
            style="flex: 1; min-width: 120px; font-weight: 400;"
          />
          <span *ngIf="!searchInputText.trim() && !searchFilterChips().length" style="font-size: 0.72rem; color: #73879f; white-space: nowrap;">Search by text or add filters</span>
          <span class="searchCount" *ngIf="messageSearchQuery.trim().length >= 2" style="min-width: 38px; font-size: 0.74rem; color: #496787; background: #edf3fb; border: 1px solid #d6e2f1; border-radius: 999px; padding: 2px 6px;">{{ currentSearchPositionLabel() }}</span>
          <button mat-icon-button type="button" class="toolbarIconBtn" *ngIf="messageSearchQuery.trim().length >= 2" (click)="prevSearchMatch()" [disabled]="searchMatchIds.length < 2" matTooltip="Previous" aria-label="Previous search result" style="width: 34px; height: 34px; line-height: 34px; display: inline-flex; align-items: center; justify-content: center;">
            <mat-icon>keyboard_arrow_up</mat-icon>
          </button>
          <button mat-icon-button type="button" class="toolbarIconBtn" *ngIf="messageSearchQuery.trim().length >= 2" (click)="nextSearchMatch()" [disabled]="searchMatchIds.length < 2" matTooltip="Next" aria-label="Next search result" style="width: 34px; height: 34px; line-height: 34px; display: inline-flex; align-items: center; justify-content: center;">
            <mat-icon>keyboard_arrow_down</mat-icon>
          </button>
          <button mat-icon-button type="button" class="toolbarIconBtn" [matMenuTriggerFor]="searchPresetMenu" (menuOpened)="onSearchFilterMenuOpened()" (menuClosed)="onSearchFilterMenuClosed()" matTooltip="Search filters" aria-label="Open search filters" style="position: relative; width: 34px; height: 34px; line-height: 34px; display: inline-flex; align-items: center; justify-content: center;">
            <mat-icon style="width: 18px; height: 18px; font-size: 18px;">{{ searchFilterCount() ? 'filter_alt' : 'tune' }}</mat-icon>
            <span *ngIf="searchFilterCount()" style="position: absolute; right: -1px; bottom: -1px; min-width: 14px; height: 14px; border-radius: 999px; background: linear-gradient(180deg, #f7fbff, #dce9f8); border: 1px solid #b9cde6; color: #2f4f72; font-size: 0.62rem; font-weight: 700; font-variant-numeric: tabular-nums; line-height: 12px; text-align: center; padding: 0 3px; box-shadow: 0 1px 2px rgba(29, 52, 81, 0.16);">{{ searchFilterCount() }}</span>
          </button>
          <button mat-icon-button type="button" class="toolbarIconBtn" (click)="toggleSearch()" matTooltip="Close search" aria-label="Close search" style="width: 34px; height: 34px; min-width: 34px; line-height: 34px; margin-left: 2px; display: inline-flex; align-items: center; justify-content: center;">
            <mat-icon style="width: 18px; height: 18px; font-size: 18px;">close</mat-icon>
          </button>
        </div>
      </div>
      <button mat-icon-button class="mobileNavBtn mobilePeopleBtn" *ngIf="isMobileView" (click)="toggleMobilePeople()" matTooltip="People">
        <mat-icon>groups</mat-icon>
      </button>
      <button
        mat-icon-button
        class="mobileNavBtn mobileMoreBtn"
        *ngIf="isMobileView"
        [matMenuTriggerFor]="mobileHeaderMenu"
        matTooltip="More"
      >
        <mat-icon>more_vert</mat-icon>
      </button>
      <button mat-icon-button *ngIf="!isMobileView" matTooltip="Profile" (click)="openProfile()">
        <mat-icon>account_circle</mat-icon>
      </button>
      <button mat-icon-button *ngIf="!isMobileView" matTooltip="Sign out" (click)="signOut()">
        <mat-icon>logout</mat-icon>
      </button>
    </mat-toolbar>

    <mat-menu #mobileHeaderMenu="matMenu" class="mobileHeaderMenu">
      <button mat-menu-item type="button" (click)="openProfile()">
        <mat-icon>account_circle</mat-icon>
        <span>Profile</span>
      </button>
      <button mat-menu-item type="button" (click)="signOut()">
        <mat-icon>logout</mat-icon>
        <span>Sign out</span>
      </button>
    </mat-menu>

    <!-- Messages -->
    <div class="messagesContainer">
      <button class="scrollToBottom" *ngIf="showScrollButton" (click)="scrollToBottom()" matTooltip="Scroll to bottom">
        <mat-icon>keyboard_arrow_down</mat-icon>
      </button>
      <div
        *ngIf="watchPartyState"
        style="position: absolute; left: 12px; right: 12px; top: 12px; z-index: 3; display: flex; align-items: center; justify-content: space-between; gap: 10px; padding: 7px 10px; border-radius: 11px; border: 1px solid #b9d2ef; background: linear-gradient(180deg, rgba(244,250,255,0.98), rgba(234,244,255,0.98)); box-shadow: 0 8px 20px rgba(30, 56, 89, 0.16);"
      >
        <div style="min-width: 0; display: flex; flex-direction: column; gap: 1px;">
          <strong style="font-size: 0.72rem; color: #204261; line-height: 1.3; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Watch party live: {{ watchPartyTitle() }}</strong>
          <span style="font-size: 0.65rem; color: #4a6a8c; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ watchPartyHostLabel() }} · {{ watchPartyContextLabel() }}</span>
        </div>
        <div style="display: inline-flex; align-items: center; gap: 4px;">
          <button mat-stroked-button type="button" style="height: 27px; line-height: 25px; border-radius: 8px;" (click)="syncWatchParty($event)">
            Sync now
          </button>
          <button mat-flat-button color="warn" type="button" *ngIf="isWatchPartyHost()" style="height: 27px; line-height: 25px; border-radius: 8px;" (click)="endWatchParty($event)">
            End
          </button>
        </div>
      </div>
      <div class="messages" (scroll)="onMessagesScroll($event)">
      
      <ng-container *ngIf="!selectedUser; else privateView">
        <div class="emptyChat" *ngIf="publicMessages.length === 0">
          <mat-icon>forum</mat-icon>
          <h3>Welcome to Public Chat</h3>
          <p>Start a conversation with everyone in the room.</p>
        </div>
        
        <button
          class="loadOlderBtn"
          mat-stroked-button
          type="button"
          *ngIf="publicHasMore && publicMessages.length > 0"
          [disabled]="publicLoading"
          (click)="loadOlderPublicMessages()"
        >
          {{ publicLoading ? 'Loading...' : 'Load older messages' }}
        </button>

        <div class="msg" *ngFor="let m of publicMessages" [class.me]="m.from === myUsername">
          <button
            type="button"
            class="userBtn"
            *ngIf="m.from !== myUsername"
            [matMenuTriggerFor]="userMenu"
            (click)="$event.stopPropagation(); menuUser=m.from; menuPublicMessage=m"
            >
            <img *ngIf="avatarUrl(m.from); else fallbackMsgUserIcon" [src]="avatarUrl(m.from)" alt="avatar" />
            <ng-template #fallbackMsgUserIcon>
              <mat-icon>account_circle</mat-icon>
            </ng-template>
            <span class="userBtnName">{{ userDisplayName(m.from) }}</span>
          </button>
          <mat-card
            class="bubble"
            [attr.data-msg-id]="m.id"
            [class.searchCurrent]="isCurrentSearchMatch(m)"
            [class.is-editing]="isEditingMessage(m, 'public')"
            [class.is-deleting]="isPendingDelete(m)"
            [class.was-edited]="isRecentlyEdited(m)"
            (dblclick)="quickReplyFromMessage(m, 'public', $event)"
            (mousedown)="startReactionPress(m, 'public', $event)"
            (mouseup)="cancelReactionPress()"
            (mouseleave)="cancelReactionPress()"
            (touchstart)="startReactionPress(m, 'public', $event)"
            (touchend)="cancelReactionPress()"
            (touchcancel)="cancelReactionPress()"
          >
            <div class="editInline" *ngIf="isEditingMessage(m, 'public'); else publicTextView">
              <input
                class="editInlineInput"
                [(ngModel)]="editingMessage!.text"
                maxlength="500"
                (keydown.enter)="saveMessageEdit(m, 'public')"
                (keydown.escape)="cancelMessageEdit()"
              />
              <div class="editInlineActions">
                <button class="iconMini" type="button" (click)="cancelMessageEdit()" matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
                <button class="iconMini primary" type="button" (click)="saveMessageEdit(m, 'public')" matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
              </div>
            </div>
            <ng-template #publicTextView>
              <button class="replySnippet" type="button" *ngIf="m.forwardedFrom" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); jumpToForwardTarget(m)">
                <span class="replyAuthor">Forwarded from {{ replyAuthorLabel(m.forwardedFrom.from) }}</span>
                <span class="replyText">{{ replyPreviewText(m.forwardedFrom.text, m.forwardedFrom.attachment, m.forwardedFrom.attachments) }}</span>
                <img *ngIf="isImageAttachment(m.forwardedFrom.attachment)" [src]="attachmentUrl(m.forwardedFrom.attachment)" [alt]="m.forwardedFrom.attachment?.name" loading="lazy" style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef;" />
                <video *ngIf="isVideoAttachment(m.forwardedFrom.attachment)" [src]="attachmentUrl(m.forwardedFrom.attachment)" preload="metadata" (loadedmetadata)="onVideoPreviewMetadata($event, m.forwardedFrom.attachment)" muted playsinline [attr.autoplay]="autoplayMediaPreviews ? '' : null" loop style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef; background: #000;"></video>
                <span class="replyText" *ngIf="m.forwardedFrom.attachment && !isAudioAttachment(m.forwardedFrom.attachment)">{{ attachmentTypeLabel(m.forwardedFrom.attachment) }} • {{ m.forwardedFrom.attachment.name }}</span>
                <span class="replyText" *ngIf="referenceAttachmentCount(m.forwardedFrom) > 1">+{{ referenceAttachmentCount(m.forwardedFrom) - 1 }} more attachments</span>
              </button>
              <ng-container *ngIf="m.forwardedFrom?.attachment as forwardedAttachment">
                <ng-container *ngIf="isAudioAttachment(forwardedAttachment)">
                  <audio
                    #forwardVoiceAudio
                    [src]="attachmentUrl(forwardedAttachment)"
                    [attr.data-voice-audio-key]="voiceAttachmentKey(forwardedAttachment)"
                    (loadedmetadata)="onVoiceAudioMetadata($event, forwardedAttachment)"
                    (timeupdate)="onVoiceAudioTimeUpdate($event, forwardedAttachment)"
                    (play)="onVoiceAudioPlay(forwardedAttachment, $event)"
                    (pause)="onVoiceAudioPause(forwardedAttachment, $event)"
                    (ended)="onVoiceAudioEnded(forwardedAttachment, $event)"
                    (error)="onVoiceAudioError($event, forwardedAttachment)"
                    preload="metadata"
                    style="display: none;"
                  ></audio>
                  <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 12px; padding: 7px 8px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin: 0 0 8px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12); width: min(260px, 70vw);">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <button mat-icon-button type="button" (click)="toggleVoicePlay(forwardedAttachment, $event, forwardVoiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                        <mat-icon style="font-size: 15px; width: 15px; height: 15px; color: #355a83;">{{ voiceIsPlaying(forwardedAttachment) ? 'pause' : 'play_arrow' }}</mat-icon>
                      </button>
                      <span style="font-size: 0.7rem; color: #486482; min-width: 34px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(forwardedAttachment) }}</span>
                      <ng-container *ngIf="voiceWaveformBars(forwardedAttachment) as bars">
                        <div
                          (pointerdown)="seekVoiceFromWaveform(forwardedAttachment, $event, forwardVoiceAudio)"
                          (pointermove)="updateVoiceWaveformSeek(forwardedAttachment, $event, forwardVoiceAudio)"
                          (pointerup)="finishVoiceWaveformSeek($event)"
                          (pointercancel)="finishVoiceWaveformSeek($event)"
                          style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 18px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                        >
                          <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, forwardedAttachment) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                          <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(forwardedAttachment) * 100"></span>
                        </div>
                      </ng-container>
                    </div>
                    <div style="font-size: 0.7rem; color: #4f6884; margin-top: 5px; padding-left: 2px;">{{ audioAttachmentLabel(forwardedAttachment) }} • {{ voiceDurationLabel(forwardedAttachment) }}<ng-container *ngIf="voiceInsightsLabel(forwardedAttachment) as voiceInfo"> • {{ voiceInfo }}</ng-container></div>
                  </div>
                </ng-container>
              </ng-container>
              <button class="replySnippet" type="button" *ngIf="m.replyTo" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); jumpToReplyTarget(m)">
                <span class="replyAuthor">{{ replyAuthorLabel(m.replyTo.from) }}</span>
                <span class="replyText">{{ replyPreviewText(m.replyTo.text, m.replyTo.attachment, m.replyTo.attachments) }}</span>
                <img *ngIf="isImageAttachment(m.replyTo.attachment)" [src]="attachmentUrl(m.replyTo.attachment)" [alt]="m.replyTo.attachment?.name" loading="lazy" style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef;" />
                <video *ngIf="isVideoAttachment(m.replyTo.attachment)" [src]="attachmentUrl(m.replyTo.attachment)" preload="metadata" (loadedmetadata)="onVideoPreviewMetadata($event, m.replyTo.attachment)" muted playsinline [attr.autoplay]="autoplayMediaPreviews ? '' : null" loop style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef; background: #000;"></video>
                <span class="replyText" *ngIf="m.replyTo.attachment && !isAudioAttachment(m.replyTo.attachment)">{{ attachmentTypeLabel(m.replyTo.attachment) }} • {{ m.replyTo.attachment.name }}</span>
                <span class="replyText" *ngIf="referenceAttachmentCount(m.replyTo) > 1">+{{ referenceAttachmentCount(m.replyTo) - 1 }} more attachments</span>
              </button>
              <ng-container *ngIf="m.replyTo?.attachment as replyAttachment">
                <ng-container *ngIf="isAudioAttachment(replyAttachment)">
                  <audio
                    #replyVoiceAudio
                    [src]="attachmentUrl(replyAttachment)"
                    [attr.data-voice-audio-key]="voiceAttachmentKey(replyAttachment)"
                    (loadedmetadata)="onVoiceAudioMetadata($event, replyAttachment)"
                    (timeupdate)="onVoiceAudioTimeUpdate($event, replyAttachment)"
                    (play)="onVoiceAudioPlay(replyAttachment, $event)"
                    (pause)="onVoiceAudioPause(replyAttachment, $event)"
                    (ended)="onVoiceAudioEnded(replyAttachment, $event)"
                    (error)="onVoiceAudioError($event, replyAttachment)"
                    preload="metadata"
                    style="display: none;"
                  ></audio>
                  <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 12px; padding: 7px 8px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin: 0 0 8px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12); width: min(260px, 70vw);">
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <button mat-icon-button type="button" (click)="toggleVoicePlay(replyAttachment, $event, replyVoiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                        <mat-icon style="font-size: 15px; width: 15px; height: 15px; color: #355a83;">{{ voiceIsPlaying(replyAttachment) ? 'pause' : 'play_arrow' }}</mat-icon>
                      </button>
                      <span style="font-size: 0.7rem; color: #486482; min-width: 34px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(replyAttachment) }}</span>
                      <ng-container *ngIf="voiceWaveformBars(replyAttachment) as bars">
                        <div
                          (pointerdown)="seekVoiceFromWaveform(replyAttachment, $event, replyVoiceAudio)"
                          (pointermove)="updateVoiceWaveformSeek(replyAttachment, $event, replyVoiceAudio)"
                          (pointerup)="finishVoiceWaveformSeek($event)"
                          (pointercancel)="finishVoiceWaveformSeek($event)"
                          style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 18px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                        >
                          <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, replyAttachment) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                          <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(replyAttachment) * 100"></span>
                        </div>
                      </ng-container>
                    </div>
                    <div style="font-size: 0.7rem; color: #4f6884; margin-top: 5px; padding-left: 2px;">{{ audioAttachmentLabel(replyAttachment) }} • {{ voiceDurationLabel(replyAttachment) }}<ng-container *ngIf="voiceInsightsLabel(replyAttachment) as voiceInfo"> • {{ voiceInfo }}</ng-container></div>
                  </div>
                </ng-container>
              </ng-container>
              <ng-container *ngIf="hasAlbumMedia(m)">
                <div *ngIf="isAlbumPreviewHidden(m, 'public')" style="display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px dashed #c7d7ea; border-radius: 10px; padding: 6px 8px; margin: 0 0 8px; background: #f6fbff; color: #3f5b79; width: min(240px, 66vw);">
                  <span style="font-size: 0.76rem;">Album preview hidden</span>
                  <button mat-stroked-button type="button" (click)="showAlbumPreview(m, 'public', $event)">Show</button>
                </div>
                <button
                  *ngIf="!isAlbumPreviewHidden(m, 'public')"
                  type="button"
                  (mousedown)="$event.stopPropagation()"
                  (touchstart)="$event.stopPropagation()"
                  (click)="openAttachmentViewer(m, 'public', albumMediaAttachments(m)[0])"
                  style="position: relative; border: 0; padding: 0; background: transparent; margin: 0 0 8px; cursor: pointer;"
                >
                  <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 4px; width: min(240px, 66vw);">
                    <div *ngFor="let attachment of albumPreviewItems(m); let i = index" style="position: relative; height: 92px; border-radius: 10px; overflow: hidden; border: 1px solid #d9e2ef; background: #0f1724;">
                      <img
                        *ngIf="isImageAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [alt]="attachment.name"
                        loading="lazy"
                        style="width: 100%; height: 100%; object-fit: cover; display: block;"
                      />
                      <video
                        *ngIf="isVideoAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [attr.data-preview-key]="attachmentPreviewKey(m, attachment, 'public')"
                        preload="none"
                        (loadedmetadata)="onVideoPreviewMetadata($event, attachment)"
                        muted
                        [attr.autoplay]="autoplayMediaPreviews ? '' : null"
                        loop
                        playsinline
                        style="width: 100%; height: 100%; object-fit: cover; display: block; background: #000;"
                      ></video>
                      <div *ngIf="isVideoAttachment(attachment)" style="position: absolute; right: 6px; bottom: 6px; background: rgba(8, 15, 25, 0.7); color: #fff; border-radius: 999px; padding: 1px 6px; font-size: 0.68rem; line-height: 1.3;">
                        {{ attachmentDurationLabel(attachment) }}
                      </div>
                      <div *ngIf="i === 3 && albumMoreCount(m) > 0" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(12, 22, 35, 0.58); color: #fff; font-weight: 600; font-size: 1rem; letter-spacing: 0.02em;">
                        +{{ albumMoreCount(m) }}
                      </div>
                    </div>
                  </div>
                </button>
              </ng-container>
              <ng-container *ngFor="let attachment of (hasAlbumMedia(m) ? nonAlbumAttachments(m) : messageAttachments(m))">
                <ng-container *ngIf="isImageAttachment(attachment) || isVideoAttachment(attachment)">
                  <div *ngIf="isAttachmentPreviewHidden(m, attachment, 'public')" style="display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px dashed #c7d7ea; border-radius: 10px; padding: 6px 8px; margin: 0 0 8px; background: #f6fbff; color: #3f5b79;">
                    <span style="font-size: 0.76rem;">Preview hidden</span>
                    <button mat-stroked-button type="button" (click)="toggleAttachmentPreview(m, attachment, 'public', $event)">Show</button>
                  </div>
                  <div *ngIf="!isAttachmentPreviewHidden(m, attachment, 'public')" style="position: relative; width: min(280px, 72vw); display: flex; justify-content: center; margin: 0 0 8px;">
                    <button
                      type="button"
                      (mousedown)="$event.stopPropagation()"
                      (touchstart)="$event.stopPropagation()"
                      (click)="openAttachmentViewer(m, 'public', attachment)"
                      style="position: relative; border: 0; padding: 0; background: transparent; cursor: pointer;"
                    >
                      <img
                        *ngIf="isImageAttachment(attachment)"
                        [src]="attachmentUrl(attachment)" loading="lazy"
                        [alt]="attachment.name"
                        style="width: min(280px, 72vw); height: 190px; object-fit: cover; border-radius: 10px; border: 1px solid #d9e2ef; display: block;"
                      />
                      <video
                        *ngIf="isVideoAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [attr.data-preview-key]="attachmentPreviewKey(m, attachment, 'public')"
                        preload="none"
                        (loadedmetadata)="onVideoPreviewMetadata($event, attachment)"
                        style="width: min(280px, 72vw); height: 190px; object-fit: cover; border-radius: 10px; border: 1px solid #d9e2ef; display: block; background: #000;"
                        [attr.autoplay]="autoplayMediaPreviews ? '' : null"
                        loop
                        muted
                        playsinline
                      ></video>
                      <div *ngIf="isVideoAttachment(attachment)" style="position: absolute; right: 6px; bottom: 6px; background: rgba(8, 15, 25, 0.7); color: #fff; border-radius: 999px; padding: 1px 6px; font-size: 0.68rem; line-height: 1.3;">
                        {{ attachmentDurationLabel(attachment) }}
                      </div>
                    </button>
                    <button mat-icon-button type="button" (click)="toggleAttachmentPreview(m, attachment, 'public', $event)" style="position: absolute; top: 4px; right: 4px; background: rgba(255,255,255,0.78);">
                      <mat-icon>visibility_off</mat-icon>
                    </button>
                  </div>
                </ng-container>
                <div
                  *ngIf="!isImageAttachment(attachment) && !isVideoAttachment(attachment)"
                  style="display: block; width: min(280px, 72vw); margin: 0 0 8px; text-decoration: none;"
                >
                  <ng-container *ngIf="isAudioAttachment(attachment)">
                  <audio
                    #voiceAudio
                    [src]="attachmentUrl(attachment)"
                    [attr.data-voice-audio-key]="voiceAttachmentKey(attachment)"
                    (loadedmetadata)="onVoiceAudioMetadata($event, attachment, m)"
                    (timeupdate)="onVoiceAudioTimeUpdate($event, attachment, m)"
                    (play)="onVoiceAudioPlay(attachment, $event, m)"
                    (pause)="onVoiceAudioPause(attachment, $event, m)"
                    (ended)="onVoiceAudioEnded(attachment, $event, m)"
                    (error)="onVoiceAudioError($event, attachment)"
                    preload="metadata"
                    style="display: none;"
                  ></audio>
                  <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 14px; padding: 9px 10px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin-bottom: 6px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12);">
                    <div style="display: flex; align-items: center; gap: 7px;">
                      <button mat-icon-button type="button" (click)="toggleVoicePlay(attachment, $event, voiceAudio)" style="width: 30px; height: 30px; min-width: 30px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                        <mat-icon style="font-size: 16px; width: 16px; height: 16px; color: #355a83;">{{ voiceIsPlaying(attachment) ? 'pause' : 'play_arrow' }}</mat-icon>
                      </button>
                      <span style="font-size: 0.72rem; color: #486482; min-width: 38px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(attachment) }}</span>
                      <ng-container *ngIf="voiceWaveformBars(attachment) as bars">
                        <div
                          (pointerdown)="seekVoiceFromWaveform(attachment, $event, voiceAudio)"
                          (pointermove)="updateVoiceWaveformSeek(attachment, $event, voiceAudio)"
                          (pointerup)="finishVoiceWaveformSeek($event)"
                          (pointercancel)="finishVoiceWaveformSeek($event)"
                          style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 20px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                        >
                          <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, attachment) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                          <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(attachment) * 100"></span>
                          <span style="position: absolute; top: 50%; width: 8px; height: 8px; border-radius: 999px; background: #2f6db3; box-shadow: 0 0 0 2px rgba(255,255,255,0.92), 0 1px 3px rgba(34, 67, 103, 0.28); pointer-events: none; transform: translate(-50%, -50%);" [style.left.%]="voiceProgressDisplayRatio(attachment) * 100"></span>
                        </div>
                      </ng-container>
                      <div
                        style="position: relative; width: 28px; height: 28px;"
                        (mouseenter)="showVoiceVolumeSlider(attachment)"
                        (mouseleave)="hideVoiceVolumeSlider(attachment)"
                      >
                        <button mat-icon-button type="button" (click)="toggleVoiceMute(attachment, $event, voiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; color: #4a6583; background: rgba(235, 243, 252, 0.75); border-radius: 999px;">
                          <mat-icon style="font-size: 16px; width: 16px; height: 16px;">{{ voiceVolumeIcon(attachment) }}</mat-icon>
                        </button>
                        <div *ngIf="isVoiceVolumeSliderVisible(attachment)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="position: absolute; left: 50%; bottom: 30px; transform: translateX(-50%); width: 24px; height: 92px; display: flex; align-items: center; justify-content: center; border: 1px solid #d5e2f1; border-radius: 999px; background: linear-gradient(180deg, #ffffff, #edf4fe); box-shadow: 0 2px 8px rgba(33, 58, 88, 0.18); z-index: 3;">
                          <input
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            [value]="voiceVolumePercent(attachment)"
                            (input)="setVoiceVolume(attachment, $any($event.target).value, $event, voiceAudio)"
                            (click)="$event.stopPropagation()"
                            (pointerdown)="$event.stopPropagation()"
                            style="width: 72px; height: 18px; accent-color: #4d7eb8; transform: rotate(-90deg);"
                            aria-label="Voice note volume"
                          />
                        </div>
                      </div>
                      <button mat-icon-button type="button" [matMenuTriggerFor]="voiceAttachmentMenu" (menuOpened)="openVoiceAttachmentMenuFor(attachment)" (click)="$event.stopPropagation()" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; color: #4a6583; background: rgba(235, 243, 252, 0.75); border-radius: 999px;">
                        <mat-icon style="font-size: 17px; width: 17px; height: 17px;">more_vert</mat-icon>
                      </button>
                    </div>
                    <div style="font-size: 0.72rem; color: #4f6884; margin-top: 6px; padding-left: 3px;">{{ audioAttachmentLabel(attachment) }} • {{ voiceDurationLabel(attachment) }} • {{ attachmentSizeLabel(attachment.size) }}<ng-container *ngIf="voiceInsightsLabel(attachment) as voiceInfo"> • {{ voiceInfo }}</ng-container><ng-container *ngIf="isVoiceOfflineCached(attachment)"> • offline</ng-container></div>
                  </div>
                  </ng-container>
                  <div *ngIf="!isAudioAttachment(attachment)" style="border: 1px solid #d9e2ef; border-radius: 10px; padding: 7px 9px; background: #f8fbff; color: #35506c;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                      <div style="min-width: 0;">
                        <strong style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ attachment.name }}</strong>
                        <div style="font-size: 0.74rem; opacity: 0.8;">{{ attachmentTypeLabel(attachment) }} • {{ attachmentSizeLabel(attachment.size) }}</div>
                      </div>
                      <button mat-icon-button type="button" [matMenuTriggerFor]="attachmentMenu" (menuOpened)="openAttachmentMenuFor(attachment)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                    </div>
                    <iframe
                      *ngIf="isTextAttachment(attachment)"
                      [src]="attachmentUrl(attachment)"
                      title="Text preview"
                      style="width: 100%; height: 130px; border: 1px solid #d9e2ef; border-radius: 10px; background: #fff; margin-top: 6px;"
                    ></iframe>
                  </div>
                </div>
              </ng-container>
              <div
                class="text"
                *ngIf="messageBodyText(m) || m.deletedAt"
                [class.deletedText]="m.deletedAt"
                [innerHTML]="m.deletedAt ? 'Message deleted' : messageTextHtml(m)"
                (click)="onMessageTextClick(m, $event)"
              ></div>
              <ng-container *ngIf="!m.deletedAt && videoLinkPreviews(m) as videoLinks">
                <div *ngIf="videoLinks.length" style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                  <div
                    *ngFor="let link of videoLinks; let i = index"
                    (mouseenter)="onVideoLinkCardHover(m, link, true)"
                    (mouseleave)="onVideoLinkCardHover(m, link, false)"
                    [style.transform]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'translateY(-2px) scale(1.005)' : 'none'"
                    [style.boxShadow]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? '0 16px 34px rgba(2, 10, 22, 0.34), 0 0 0 1px rgba(137, 179, 227, 0.36)' : '0 10px 24px rgba(3, 12, 23, 0.28)'"
                    [style.animation]="videoLinkMotionIntensity === 'full' ? 'messagePop 320ms cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none'"
                    style="position: relative; border-radius: 16px; padding: 1px; background: linear-gradient(128deg, rgba(103, 158, 225, 0.76), rgba(35, 88, 153, 0.54) 52%, rgba(39, 141, 194, 0.48)); transition: transform 220ms ease, box-shadow 220ms ease;"
                  >
                    <div style="position: relative; overflow: hidden; border-radius: 15px; padding: 8px; background: linear-gradient(180deg, rgba(8, 20, 37, 0.95), rgba(6, 14, 26, 0.98)); backdrop-filter: blur(1px);">
                      <span [style.opacity]="isVideoLinkCardHovered(m, link) ? '0.9' : '0.6'" style="position: absolute; left: -18%; top: -40%; width: 60%; height: 90%; border-radius: 999px; background: radial-gradient(circle, rgba(118, 181, 255, 0.42), transparent 68%); filter: blur(18px); pointer-events: none; transition: opacity 200ms ease;"></span>
                      <span [style.opacity]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? '0.28' : '0.12'" [style.animation]="videoLinkMotionIntensity === 'full' ? 'shimmer 3.4s linear infinite' : 'none'" style="position: absolute; inset: 0; pointer-events: none; background: linear-gradient(110deg, rgba(255,255,255,0) 26%, rgba(188,220,255,0.3) 48%, rgba(255,255,255,0) 70%); background-size: 220% 100%;"></span>

                      <div style="position: relative; z-index: 1; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
                        <div style="display: inline-flex; align-items: center; gap: 6px; min-width: 0;">
                          <span [ngStyle]="videoLinkProviderChipStyle(link)" style="display: inline-flex; align-items: center; height: 21px; border-radius: 999px; padding: 0 9px; font-size: 0.63rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;">{{ link.providerLabel }}</span>
                          <span style="font-size: 0.63rem; color: #a9c7e8;">inline preview</span>
                        </div>
                        <div
                          [style.opacity]="videoLinkActionBarVisible(m, link) ? '1' : '0.02'"
                          [style.transform]="videoLinkActionBarVisible(m, link) ? 'translateY(0)' : 'translateY(-6px)'"
                          [style.pointerEvents]="videoLinkActionBarVisible(m, link) ? 'auto' : 'none'"
                          class="videoLinkActionBar"
                          style="display: inline-flex; align-items: center; gap: 4px; transition: opacity 180ms ease, transform 220ms ease;"
                        >
                          <a class="videoLinkActionLink" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; text-decoration: none;" [href]="link.sourceUrl" target="_blank" rel="noopener" matTooltip="Open in new tab" (click)="$event.stopPropagation()">
                            <mat-icon>open_in_new</mat-icon>
                          </a>
                          <button type="button" class="videoLinkActionBtn" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; cursor: pointer;" (click)="toggleVideoLinkInline(m, link, $event)" [matTooltip]="videoLinkToggleLabel(m, link)">
                            <mat-icon>{{ isVideoLinkInChatOpen(m, link) ? 'expand_less' : 'expand_more' }}</mat-icon>
                          </button>
                          <button type="button" class="videoLinkActionBtn" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; cursor: pointer;" [matMenuTriggerFor]="videoLinkMoreMenuPublic" (click)="$event.stopPropagation()" matTooltip="More actions">
                            <mat-icon>more_horiz</mat-icon>
                          </button>
                          <mat-menu #videoLinkMoreMenuPublic="matMenu" xPosition="before">
                            <button mat-menu-item type="button" (click)="copyVideoLink(link)">
                              <mat-icon>content_copy</mat-icon>
                              <span>Copy link</span>
                            </button>
                            <button mat-menu-item type="button" (click)="shareVideoLink(link)">
                              <mat-icon>ios_share</mat-icon>
                              <span>Share link</span>
                            </button>
                            <button mat-menu-item type="button" (click)="toggleWatchPartyFromLink(m, link)" [matTooltip]="watchPartyToggleLabel(link)">
                              <mat-icon>{{ isWatchPartyForLink(link) ? 'groups' : 'group_add' }}</mat-icon>
                              <span>{{ watchPartyToggleLabel(link) }}</span>
                            </button>
                          </mat-menu>
                        </div>
                      </div>

                      <div style="position: relative; z-index: 1; margin: -2px 0 8px; display: flex; flex-direction: column; gap: 2px;">
                        <strong style="font-size: 0.74rem; color: #f2f8ff; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ videoLinkMetaTitle(link) }}</strong>
                        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 0.65rem; color: #b3cee8;">
                          <span style="max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ videoLinkMetaSubtitle(link) }}</span>
                          <span *ngIf="videoLinkMetaDurationLabel(link) as metaDuration" style="border-radius: 999px; padding: 1px 7px; background: rgba(133, 173, 215, 0.18); border: 1px solid rgba(148, 187, 226, 0.26);">{{ metaDuration }}</span>
                          <span *ngIf="videoLinkStartLabel(link) as startLabel" style="border-radius: 999px; padding: 1px 7px; background: rgba(133, 173, 215, 0.18); border: 1px solid rgba(148, 187, 226, 0.26);">starts {{ startLabel }}</span>
                        </div>
                      </div>

                      <div style="position: relative; z-index: 1; border-radius: 12px; overflow: hidden; border: 1px solid rgba(163, 194, 229, 0.42); background: #0a1019; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);">
                        <button
                          *ngIf="!isVideoLinkInChatOpen(m, link)"
                          type="button"
                          (click)="openVideoLinkInChat(m, link, $event)"
                          [style.transform]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'scale(1.015)' : 'scale(1)'"
                          style="position: relative; width: min(360px, 72vw); max-width: 100%; padding-top: 56.25%; display: block; border: 0; margin: 0; background: transparent; cursor: pointer; transition: transform 240ms ease;"
                        >
                          <span [style.background]="videoLinkHeroBackground(link)" style="position: absolute; inset: 0; display: block;"></span>
                          <span style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(9, 16, 26, 0.2), rgba(9, 16, 26, 0.68));"></span>
                          <span [style.animation]="videoLinkMotionIntensity === 'full' ? 'shimmer 2.9s linear infinite' : 'none'" style="position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, rgba(255,255,255,0) 22%, rgba(255,255,255,0.22) 48%, rgba(255,255,255,0) 72%); background-size: 200% 100%;"></span>
                          <span [style.animation]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'glowPulse 1.9s ease-in-out infinite' : 'none'" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; border-radius: 999px; border: 1px solid rgba(239, 247, 255, 0.54); background: rgba(8, 16, 28, 0.54); color: #f6fbff; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0,0,0,0.3);">
                            <mat-icon style="font-size: 30px; width: 30px; height: 30px; margin-left: 2px;">play_arrow</mat-icon>
                          </span>
                          <span style="position: absolute; left: 10px; bottom: 10px; color: #f3f9ff; font-size: 0.66rem; letter-spacing: 0.04em; text-transform: uppercase; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ link.providerLabel }} preview</span>
                        </button>

                        <div
                          *ngIf="isVideoLinkInChatOpen(m, link)"
                          [attr.data-inline-player-key]="videoLinkDomKey(m, link)"
                          [ngStyle]="videoLinkPlayerFrameStyle(m, link)"
                          (mousedown)="$event.stopPropagation()"
                          (touchstart)="$event.stopPropagation()"
                          (click)="$event.stopPropagation()"
                          style="position: relative; width: min(360px, 72vw); max-width: 100%; padding-top: 56.25%; background: #000;"
                        >
                          <div *ngIf="isVideoLinkDocked(m, link)" style="position: absolute; left: 0; right: 0; top: 0; z-index: 2; display: flex; align-items: center; justify-content: space-between; gap: 6px; padding: 4px 6px; color: #e4f2ff; background: linear-gradient(180deg, rgba(4, 11, 20, 0.86), rgba(4, 11, 20, 0.5));">
                            <span style="font-size: 0.62rem; letter-spacing: 0.04em; text-transform: uppercase; opacity: 0.86;">Docked player</span>
                            <div style="display: inline-flex; gap: 4px;">
                              <button mat-icon-button type="button" (click)="toggleVideoLinkInline(m, link, $event)" style="width: 20px; height: 20px; min-width: 20px; color: #eef8ff;">
                                <mat-icon style="font-size: 14px; width: 14px; height: 14px;">close</mat-icon>
                              </button>
                            </div>
                          </div>
                          <iframe
                            [src]="videoLinkEmbedUrl(m, link)"
                            title="In-chat video player"
                            allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0;"
                          ></iframe>
                          <span style="position: absolute; inset: 0; pointer-events: none; box-shadow: inset 0 0 0 1px rgba(176, 208, 241, 0.26);"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-template>
            <div class="meta">
              <div class="messageActions" *ngIf="!isEditingMessage(m, 'public') && !m.deletedAt">
                <button class="actionBtn" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); replyToMessage(m, 'public')" matTooltip="Reply">
                  <mat-icon>reply</mat-icon>
                </button>
                <button class="actionBtn" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); openForwardDialog(m, 'public')" matTooltip="Forward">
                  <mat-icon>forward</mat-icon>
                </button>
                <button class="actionBtn" type="button" *ngIf="canEditMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); editMessage(m, 'public')" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="actionBtn danger" type="button" *ngIf="canManageMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); deleteMessage(m, 'public')" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="metaInfo">
                <span class="editedTag" *ngIf="m.editedAt && !m.deletedAt">edited</span>
                <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
              </div>
            </div>
            <div class="reactionsSummary" *ngIf="visibleReactions(m).length">
              <span class="reactionPill" *ngFor="let r of visibleReactions(m)">
                {{ r.emoji }} {{ r.users.length }}
              </span>
            </div>
            <div class="reactionPicker" *ngIf="isReactionPickerOpen(m, 'public')" (click)="$event.stopPropagation()">
              <button
                class="reactionOption"
                type="button"
                *ngFor="let emoji of messageReactions"
                [class.active]="hasReactionByMe(m, emoji)"
                (click)="toggleReaction(m, 'public', emoji)"
              >
                {{ emoji }}
                <span *ngIf="reactionCount(m, emoji)">{{ reactionCount(m, emoji) }}</span>
              </button>
            </div>
          </mat-card>
          <button
            type="button"
            class="userBtn meUserBtn"
            *ngIf="m.from === myUsername"
            >
            <img *ngIf="avatarUrl(m.from); else fallbackMyAvatar" [src]="avatarUrl(m.from)" alt="avatar" />
            <ng-template #fallbackMyAvatar>
              <mat-icon>account_circle</mat-icon>
            </ng-template>
            <span class="userBtnName">{{ userDisplayName(m.from) }}</span>
          </button>
        </div>
      </ng-container>

      <ng-template #privateView>
        <button class="loadOlderBtn" mat-stroked-button type="button" *ngIf="hiddenThreadMessageCount() > 0" (click)="loadMoreThreadMessages()">
          Load older in view ({{ hiddenThreadMessageCount() }})
        </button>
        <ng-container *ngFor="let m of displayedThreadMessages()">
        <div
          *ngIf="shouldShowUnreadDivider(m)"
          style="margin: 10px auto 8px; width: fit-content; background: #fff5d7; border: 1px solid #f1dfa3; color: #7c6322; font-size: 0.74rem; border-radius: 999px; padding: 2px 10px;"
        >
          Unread messages
        </div>
        <div class="msg" [class.me]="m.from === myUsername">
          <mat-card
            class="bubble"
            [attr.data-msg-id]="m.id"
            [class.searchCurrent]="isCurrentSearchMatch(m)"
            [class.is-editing]="isEditingMessage(m, 'private')"
            [class.is-deleting]="isPendingDelete(m)"
            [class.was-edited]="isRecentlyEdited(m)"
            (mousedown)="startReactionPress(m, 'private', $event)"
            (mouseup)="cancelReactionPress()"
            (dblclick)="quickReplyFromMessage(m, 'private', $event)"
            (mouseleave)="cancelReactionPress()"
            (touchstart)="startReactionPress(m, 'private', $event)"
            (touchend)="cancelReactionPress()"
            (touchcancel)="cancelReactionPress()"
          >
            <div class="editInline" *ngIf="isEditingMessage(m, 'private'); else privateTextView">
              <input
                class="editInlineInput"
                [(ngModel)]="editingMessage!.text"
                maxlength="500"
                (keydown.enter)="saveMessageEdit(m, 'private')"
                (keydown.escape)="cancelMessageEdit()"
              />
              <div class="editInlineActions">
                <button class="iconMini" type="button" (click)="cancelMessageEdit()" matTooltip="Cancel">
                  <mat-icon>close</mat-icon>
                </button>
                <button class="iconMini primary" type="button" (click)="saveMessageEdit(m, 'private')" matTooltip="Save">
                  <mat-icon>check</mat-icon>
                </button>
              </div>
            </div>
            <ng-template #privateTextView>
              <button class="replySnippet" type="button" *ngIf="m.forwardedFrom" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); jumpToForwardTarget(m)">
                <span class="replyAuthor">Forwarded from {{ replyAuthorLabel(m.forwardedFrom.from) }}</span>
                <span class="replyText">{{ replyPreviewText(m.forwardedFrom.text, m.forwardedFrom.attachment, m.forwardedFrom.attachments) }}</span>
                <span class="replyText" *ngIf="referenceMetaLabel(m.forwardedFrom) as forwardedMeta">{{ forwardedMeta }}</span>
                <span
                  class="replyText"
                  *ngIf="referenceAttachmentCount(m.forwardedFrom) && !referenceMediaAttachments(m.forwardedFrom).length && !referenceAudioAttachmentCount(m.forwardedFrom)"
                  (click)="jumpToReferenceAttachment(m.forwardedFrom, preferredReferenceAttachment(referenceAttachments(m.forwardedFrom)), $event)"
                  style="text-decoration: underline; cursor: pointer;"
                >
                  Open source file
                </span>
                <ng-container *ngIf="referenceAlbumPreviewItems(m.forwardedFrom) as forwardedMediaItems">
                  <div
                    *ngIf="forwardedMediaItems.length > 1"
                    (click)="$event.stopPropagation()"
                    style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 3px; width: min(178px, 52vw); margin-top: 4px;"
                  >
                    <div
                      *ngFor="let media of forwardedMediaItems; let i = index"
                      (click)="jumpToReferenceAttachment(m.forwardedFrom, media, $event)"
                      style="position: relative; height: 58px; border-radius: 8px; overflow: hidden; border: 1px solid #d7e1ee; background: #0f1724; cursor: pointer;"
                    >
                      <img *ngIf="isImageAttachment(media)" [src]="attachmentUrl(media)" [alt]="media.name" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                      <video *ngIf="isVideoAttachment(media)" [src]="attachmentUrl(media)" preload="metadata" muted playsinline style="width: 100%; height: 100%; object-fit: cover; display: block; background: #000;"></video>
                      <div *ngIf="isVideoAttachment(media)" style="position: absolute; right: 4px; bottom: 4px; background: rgba(8, 15, 25, 0.72); color: #fff; border-radius: 999px; padding: 1px 5px; font-size: 0.62rem; line-height: 1.25;">
                        {{ attachmentDurationLabel(media) }}
                      </div>
                      <div *ngIf="i === 3 && referenceAlbumMoreCount(m.forwardedFrom) > 0" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(12, 22, 35, 0.58); color: #fff; font-weight: 600; font-size: 0.86rem; letter-spacing: 0.02em;">
                        +{{ referenceAlbumMoreCount(m.forwardedFrom) }}
                      </div>
                    </div>
                  </div>
                  <div
                    *ngIf="forwardedMediaItems.length === 1"
                    (click)="jumpToReferenceAttachment(m.forwardedFrom, forwardedMediaItems[0], $event)"
                    style="position: relative; margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef; overflow: hidden; cursor: pointer;"
                  >
                    <img *ngIf="isImageAttachment(forwardedMediaItems[0])" [src]="attachmentUrl(forwardedMediaItems[0])" [alt]="forwardedMediaItems[0].name" loading="lazy" style="display: block; width: 84px; height: 52px; object-fit: cover;" />
                    <video *ngIf="isVideoAttachment(forwardedMediaItems[0])" [src]="attachmentUrl(forwardedMediaItems[0])" preload="metadata" muted playsinline style="display: block; width: 84px; height: 52px; object-fit: cover; background: #000;"></video>
                  </div>
                </ng-container>
              </button>
              <ng-container *ngIf="referenceAudioCurrentAttachment(m.forwardedFrom) as forwardedAudio">
                <audio
                  #privateForwardVoiceAudio
                  [src]="attachmentUrl(forwardedAudio)"
                  [attr.data-voice-audio-key]="voiceAttachmentKey(forwardedAudio)"
                  (loadedmetadata)="onVoiceAudioMetadata($event, forwardedAudio)"
                  (timeupdate)="onVoiceAudioTimeUpdate($event, forwardedAudio)"
                  (play)="onVoiceAudioPlay(forwardedAudio, $event)"
                  (pause)="onVoiceAudioPause(forwardedAudio, $event)"
                  (ended)="onVoiceAudioEnded(forwardedAudio, $event)"
                  (error)="onVoiceAudioError($event, forwardedAudio)"
                  preload="metadata"
                  style="display: none;"
                ></audio>
                <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 12px; padding: 7px 8px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin: 0 0 8px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12); width: min(260px, 70vw);">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <button mat-icon-button type="button" *ngIf="referenceAudioAttachmentCount(m.forwardedFrom) > 1" (click)="prevReferenceAudio(m.forwardedFrom, $event)" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center; color: #507196;">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px;">skip_previous</mat-icon>
                    </button>
                    <button mat-icon-button type="button" (click)="toggleVoicePlay(forwardedAudio, $event, privateForwardVoiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px; color: #355a83;">{{ voiceIsPlaying(forwardedAudio) ? 'pause' : 'play_arrow' }}</mat-icon>
                    </button>
                    <span style="font-size: 0.7rem; color: #486482; min-width: 34px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(forwardedAudio) }}</span>
                    <ng-container *ngIf="voiceWaveformBars(forwardedAudio) as bars">
                      <div
                        (pointerdown)="seekVoiceFromWaveform(forwardedAudio, $event, privateForwardVoiceAudio)"
                        (pointermove)="updateVoiceWaveformSeek(forwardedAudio, $event, privateForwardVoiceAudio)"
                        (pointerup)="finishVoiceWaveformSeek($event)"
                        (pointercancel)="finishVoiceWaveformSeek($event)"
                        style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 18px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                      >
                        <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, forwardedAudio) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                        <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(forwardedAudio) * 100"></span>
                      </div>
                    </ng-container>
                    <button mat-icon-button type="button" *ngIf="referenceAudioAttachmentCount(m.forwardedFrom) > 1" (click)="nextReferenceAudio(m.forwardedFrom, $event)" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center; color: #507196;">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px;">skip_next</mat-icon>
                    </button>
                  </div>
                  <div style="font-size: 0.7rem; color: #4f6884; margin-top: 5px; padding-left: 2px; display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                    <span>{{ audioAttachmentLabel(forwardedAudio) }} • {{ referenceAudioIndex(m.forwardedFrom) + 1 }}/{{ referenceAudioAttachmentCount(m.forwardedFrom) }} • {{ voiceDurationLabel(forwardedAudio) }}<ng-container *ngIf="voiceInsightsLabel(forwardedAudio) as voiceInfo"> • {{ voiceInfo }}</ng-container></span>
                    <button mat-icon-button type="button" (click)="jumpToReferenceAttachment(m.forwardedFrom, forwardedAudio, $event)" style="width: 20px; height: 20px; min-width: 20px; display: inline-flex; align-items: center; justify-content: center; color: #557496;" matTooltip="Open source attachment">
                      <mat-icon style="font-size: 14px; width: 14px; height: 14px;">open_in_new</mat-icon>
                    </button>
                  </div>
                </div>
              </ng-container>
              <button class="replySnippet" type="button" *ngIf="m.replyTo" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); jumpToReplyTarget(m)">
                <span class="replyAuthor">{{ replyAuthorLabel(m.replyTo.from) }}</span>
                <span class="replyText">{{ replyPreviewText(m.replyTo.text, m.replyTo.attachment, m.replyTo.attachments) }}</span>
                <span class="replyText" *ngIf="referenceMetaLabel(m.replyTo) as replyMeta">{{ replyMeta }}</span>
                <span
                  class="replyText"
                  *ngIf="referenceAttachmentCount(m.replyTo) && !referenceMediaAttachments(m.replyTo).length && !referenceAudioAttachmentCount(m.replyTo)"
                  (click)="jumpToReferenceAttachment(m.replyTo, preferredReferenceAttachment(referenceAttachments(m.replyTo)), $event)"
                  style="text-decoration: underline; cursor: pointer;"
                >
                  Open source file
                </span>
                <ng-container *ngIf="referenceAlbumPreviewItems(m.replyTo) as replyMediaItems">
                  <div
                    *ngIf="replyMediaItems.length > 1"
                    (click)="$event.stopPropagation()"
                    style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 3px; width: min(178px, 52vw); margin-top: 4px;"
                  >
                    <div
                      *ngFor="let media of replyMediaItems; let i = index"
                      (click)="jumpToReferenceAttachment(m.replyTo, media, $event)"
                      style="position: relative; height: 58px; border-radius: 8px; overflow: hidden; border: 1px solid #d7e1ee; background: #0f1724; cursor: pointer;"
                    >
                      <img *ngIf="isImageAttachment(media)" [src]="attachmentUrl(media)" [alt]="media.name" loading="lazy" style="width: 100%; height: 100%; object-fit: cover; display: block;" />
                      <video *ngIf="isVideoAttachment(media)" [src]="attachmentUrl(media)" preload="metadata" muted playsinline style="width: 100%; height: 100%; object-fit: cover; display: block; background: #000;"></video>
                      <div *ngIf="isVideoAttachment(media)" style="position: absolute; right: 4px; bottom: 4px; background: rgba(8, 15, 25, 0.72); color: #fff; border-radius: 999px; padding: 1px 5px; font-size: 0.62rem; line-height: 1.25;">
                        {{ attachmentDurationLabel(media) }}
                      </div>
                      <div *ngIf="i === 3 && referenceAlbumMoreCount(m.replyTo) > 0" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(12, 22, 35, 0.58); color: #fff; font-weight: 600; font-size: 0.86rem; letter-spacing: 0.02em;">
                        +{{ referenceAlbumMoreCount(m.replyTo) }}
                      </div>
                    </div>
                  </div>
                  <div
                    *ngIf="replyMediaItems.length === 1"
                    (click)="jumpToReferenceAttachment(m.replyTo, replyMediaItems[0], $event)"
                    style="position: relative; margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef; overflow: hidden; cursor: pointer;"
                  >
                    <img *ngIf="isImageAttachment(replyMediaItems[0])" [src]="attachmentUrl(replyMediaItems[0])" [alt]="replyMediaItems[0].name" loading="lazy" style="display: block; width: 84px; height: 52px; object-fit: cover;" />
                    <video *ngIf="isVideoAttachment(replyMediaItems[0])" [src]="attachmentUrl(replyMediaItems[0])" preload="metadata" muted playsinline style="display: block; width: 84px; height: 52px; object-fit: cover; background: #000;"></video>
                  </div>
                </ng-container>
              </button>
              <ng-container *ngIf="referenceAudioCurrentAttachment(m.replyTo) as replyAudio">
                <audio
                  #privateReplyVoiceAudio
                  [src]="attachmentUrl(replyAudio)"
                  [attr.data-voice-audio-key]="voiceAttachmentKey(replyAudio)"
                  (loadedmetadata)="onVoiceAudioMetadata($event, replyAudio)"
                  (timeupdate)="onVoiceAudioTimeUpdate($event, replyAudio)"
                  (play)="onVoiceAudioPlay(replyAudio, $event)"
                  (pause)="onVoiceAudioPause(replyAudio, $event)"
                  (ended)="onVoiceAudioEnded(replyAudio, $event)"
                  (error)="onVoiceAudioError($event, replyAudio)"
                  preload="metadata"
                  style="display: none;"
                ></audio>
                <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 12px; padding: 7px 8px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin: 0 0 8px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12); width: min(260px, 70vw);">
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <button mat-icon-button type="button" *ngIf="referenceAudioAttachmentCount(m.replyTo) > 1" (click)="prevReferenceAudio(m.replyTo, $event)" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center; color: #507196;">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px;">skip_previous</mat-icon>
                    </button>
                    <button mat-icon-button type="button" (click)="toggleVoicePlay(replyAudio, $event, privateReplyVoiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px; color: #355a83;">{{ voiceIsPlaying(replyAudio) ? 'pause' : 'play_arrow' }}</mat-icon>
                    </button>
                    <span style="font-size: 0.7rem; color: #486482; min-width: 34px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(replyAudio) }}</span>
                    <ng-container *ngIf="voiceWaveformBars(replyAudio) as bars">
                      <div
                        (pointerdown)="seekVoiceFromWaveform(replyAudio, $event, privateReplyVoiceAudio)"
                        (pointermove)="updateVoiceWaveformSeek(replyAudio, $event, privateReplyVoiceAudio)"
                        (pointerup)="finishVoiceWaveformSeek($event)"
                        (pointercancel)="finishVoiceWaveformSeek($event)"
                        style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 18px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                      >
                        <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, replyAudio) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                        <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(replyAudio) * 100"></span>
                      </div>
                    </ng-container>
                    <button mat-icon-button type="button" *ngIf="referenceAudioAttachmentCount(m.replyTo) > 1" (click)="nextReferenceAudio(m.replyTo, $event)" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center; color: #507196;">
                      <mat-icon style="font-size: 15px; width: 15px; height: 15px;">skip_next</mat-icon>
                    </button>
                  </div>
                  <div style="font-size: 0.7rem; color: #4f6884; margin-top: 5px; padding-left: 2px; display: flex; align-items: center; justify-content: space-between; gap: 6px;">
                    <span>{{ audioAttachmentLabel(replyAudio) }} • {{ referenceAudioIndex(m.replyTo) + 1 }}/{{ referenceAudioAttachmentCount(m.replyTo) }} • {{ voiceDurationLabel(replyAudio) }}<ng-container *ngIf="voiceInsightsLabel(replyAudio) as voiceInfo"> • {{ voiceInfo }}</ng-container></span>
                    <button mat-icon-button type="button" (click)="jumpToReferenceAttachment(m.replyTo, replyAudio, $event)" style="width: 20px; height: 20px; min-width: 20px; display: inline-flex; align-items: center; justify-content: center; color: #557496;" matTooltip="Open source attachment">
                      <mat-icon style="font-size: 14px; width: 14px; height: 14px;">open_in_new</mat-icon>
                    </button>
                  </div>
                </div>
              </ng-container>
              <ng-container *ngIf="hasAlbumMedia(m)">
                <div *ngIf="isAlbumPreviewHidden(m, 'private')" style="display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px dashed #c7d7ea; border-radius: 10px; padding: 6px 8px; margin: 0 0 8px; background: #f6fbff; color: #3f5b79; width: min(240px, 66vw);">
                  <span style="font-size: 0.76rem;">Album preview hidden</span>
                  <button mat-stroked-button type="button" (click)="showAlbumPreview(m, 'private', $event)">Show</button>
                </div>
                <button
                  *ngIf="!isAlbumPreviewHidden(m, 'private')"
                  type="button"
                  (mousedown)="$event.stopPropagation()"
                  (touchstart)="$event.stopPropagation()"
                  (click)="openAttachmentViewer(m, 'private', albumMediaAttachments(m)[0])"
                  style="position: relative; border: 0; padding: 0; background: transparent; margin: 0 0 8px; cursor: pointer;"
                >
                  <div style="display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 4px; width: min(240px, 66vw);">
                    <div *ngFor="let attachment of albumPreviewItems(m); let i = index" style="position: relative; height: 92px; border-radius: 10px; overflow: hidden; border: 1px solid #d9e2ef; background: #0f1724;">
                      <img
                        *ngIf="isImageAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [alt]="attachment.name"
                        loading="lazy"
                        style="width: 100%; height: 100%; object-fit: cover; display: block;"
                      />
                      <video
                        *ngIf="isVideoAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [attr.data-preview-key]="attachmentPreviewKey(m, attachment, 'private')"
                        preload="none"
                        (loadedmetadata)="onVideoPreviewMetadata($event, attachment)"
                        muted
                        [attr.autoplay]="autoplayMediaPreviews ? '' : null"
                        loop
                        playsinline
                        style="width: 100%; height: 100%; object-fit: cover; display: block; background: #000;"
                      ></video>
                      <div *ngIf="isVideoAttachment(attachment)" style="position: absolute; right: 6px; bottom: 6px; background: rgba(8, 15, 25, 0.7); color: #fff; border-radius: 999px; padding: 1px 6px; font-size: 0.68rem; line-height: 1.3;">
                        {{ attachmentDurationLabel(attachment) }}
                      </div>
                      <div *ngIf="i === 3 && albumMoreCount(m) > 0" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(12, 22, 35, 0.58); color: #fff; font-weight: 600; font-size: 1rem; letter-spacing: 0.02em;">
                        +{{ albumMoreCount(m) }}
                      </div>
                    </div>
                  </div>
                </button>
              </ng-container>
              <ng-container *ngFor="let attachment of (hasAlbumMedia(m) ? nonAlbumAttachments(m) : messageAttachments(m))">
                <ng-container *ngIf="isImageAttachment(attachment) || isVideoAttachment(attachment)">
                  <div *ngIf="isAttachmentPreviewHidden(m, attachment, 'private')" style="display: flex; align-items: center; justify-content: space-between; gap: 10px; border: 1px dashed #c7d7ea; border-radius: 10px; padding: 6px 8px; margin: 0 0 8px; background: #f6fbff; color: #3f5b79;">
                    <span style="font-size: 0.76rem;">Preview hidden</span>
                    <button mat-stroked-button type="button" (click)="toggleAttachmentPreview(m, attachment, 'private', $event)">Show</button>
                  </div>
                  <div *ngIf="!isAttachmentPreviewHidden(m, attachment, 'private')" style="position: relative; width: min(280px, 72vw); display: flex; justify-content: center; margin: 0 0 8px;">
                    <button
                      type="button"
                      (mousedown)="$event.stopPropagation()"
                      (touchstart)="$event.stopPropagation()"
                      (click)="openAttachmentViewer(m, 'private', attachment)"
                      style="position: relative; border: 0; padding: 0; background: transparent; cursor: pointer;"
                    >
                      <img
                        *ngIf="isImageAttachment(attachment)"
                        [src]="attachmentUrl(attachment)" loading="lazy"
                        [alt]="attachment.name"
                        style="width: min(280px, 72vw); height: 190px; object-fit: cover; border-radius: 10px; border: 1px solid #d9e2ef; display: block;"
                      />
                      <video
                        *ngIf="isVideoAttachment(attachment)"
                        [src]="attachmentUrl(attachment)"
                        [attr.data-preview-key]="attachmentPreviewKey(m, attachment, 'private')"
                        preload="none"
                        (loadedmetadata)="onVideoPreviewMetadata($event, attachment)"
                        style="width: min(280px, 72vw); height: 190px; object-fit: cover; border-radius: 10px; border: 1px solid #d9e2ef; display: block; background: #000;"
                        [attr.autoplay]="autoplayMediaPreviews ? '' : null"
                        loop
                        muted
                        playsinline
                      ></video>
                      <div *ngIf="isVideoAttachment(attachment)" style="position: absolute; right: 6px; bottom: 6px; background: rgba(8, 15, 25, 0.7); color: #fff; border-radius: 999px; padding: 1px 6px; font-size: 0.68rem; line-height: 1.3;">
                        {{ attachmentDurationLabel(attachment) }}
                      </div>
                    </button>
                    <button mat-icon-button type="button" (click)="toggleAttachmentPreview(m, attachment, 'private', $event)" style="position: absolute; top: 4px; right: 4px; background: rgba(255,255,255,0.78);">
                      <mat-icon>visibility_off</mat-icon>
                    </button>
                  </div>
                </ng-container>
                <div
                  *ngIf="!isImageAttachment(attachment) && !isVideoAttachment(attachment)"
                  style="display: block; width: min(280px, 72vw); margin: 0 0 8px; text-decoration: none;"
                >
                  <ng-container *ngIf="isAudioAttachment(attachment)">
                  <audio
                    #voiceAudio
                    [src]="attachmentUrl(attachment)"
                    [attr.data-voice-audio-key]="voiceAttachmentKey(attachment)"
                    (loadedmetadata)="onVoiceAudioMetadata($event, attachment, m)"
                    (timeupdate)="onVoiceAudioTimeUpdate($event, attachment, m)"
                    (play)="onVoiceAudioPlay(attachment, $event, m)"
                    (pause)="onVoiceAudioPause(attachment, $event, m)"
                    (ended)="onVoiceAudioEnded(attachment, $event, m)"
                    (error)="onVoiceAudioError($event, attachment)"
                    preload="metadata"
                    style="display: none;"
                  ></audio>
                  <div class="voicePlayerShell" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="border: 1px solid #d4e1f2; border-radius: 14px; padding: 9px 10px; background: linear-gradient(180deg, #ffffff, #f3f8ff); color: #35506c; margin-bottom: 6px; box-shadow: inset 0 1px 0 rgba(255,255,255,0.92), 0 2px 4px rgba(34, 60, 92, 0.12);">
                    <div style="display: flex; align-items: center; gap: 7px;">
                      <button mat-icon-button type="button" (click)="toggleVoicePlay(attachment, $event, voiceAudio)" style="width: 30px; height: 30px; min-width: 30px; display: inline-flex; align-items: center; justify-content: center; background: linear-gradient(180deg, #f6faff, #e6f0fc); border: 1px solid #cfdff1; border-radius: 999px; box-shadow: 0 1px 2px rgba(38, 63, 95, 0.15);">
                        <mat-icon style="font-size: 16px; width: 16px; height: 16px; color: #355a83;">{{ voiceIsPlaying(attachment) ? 'pause' : 'play_arrow' }}</mat-icon>
                      </button>
                      <span style="font-size: 0.72rem; color: #486482; min-width: 38px; text-align: center; font-variant-numeric: tabular-nums;">{{ voiceCurrentTimeLabel(attachment) }}</span>
                      <ng-container *ngIf="voiceWaveformBars(attachment) as bars">
                        <div
                          (pointerdown)="seekVoiceFromWaveform(attachment, $event, voiceAudio)"
                          (pointermove)="updateVoiceWaveformSeek(attachment, $event, voiceAudio)"
                          (pointerup)="finishVoiceWaveformSeek($event)"
                          (pointercancel)="finishVoiceWaveformSeek($event)"
                          style="position: relative; display: flex; align-items: center; justify-content: space-between; gap: 0; flex: 1; height: 20px; cursor: pointer; touch-action: none; border-radius: 999px; padding: 1px 4px; overflow: hidden; background: linear-gradient(180deg, #fbfdff, #ecf4ff); border: 1px solid #d9e6f7; box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);"
                        >
                          <span *ngFor="let bar of bars; let i = index; trackBy: trackByNumber" [style.height.px]="bar" [style.background]="isVoiceWaveformBarActive(i, bars.length, attachment) ? 'linear-gradient(180deg, #4f84bf, #336ba9)' : 'linear-gradient(180deg, #cddff4, #a8c4e5)'" style="display: inline-block; width: 2px; border-radius: 999px; align-self: center; flex: 0 0 auto;"></span>
                          <span style="position: absolute; top: 1px; bottom: 1px; width: 2px; border-radius: 999px; background: rgba(28, 79, 142, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.8), 0 0 8px rgba(54, 110, 177, 0.28); pointer-events: none; transform: translateX(-50%);" [style.left.%]="voiceProgressDisplayRatio(attachment) * 100"></span>
                          <span style="position: absolute; top: 50%; width: 8px; height: 8px; border-radius: 999px; background: #2f6db3; box-shadow: 0 0 0 2px rgba(255,255,255,0.92), 0 1px 3px rgba(34, 67, 103, 0.28); pointer-events: none; transform: translate(-50%, -50%);" [style.left.%]="voiceProgressDisplayRatio(attachment) * 100"></span>
                        </div>
                      </ng-container>
                      <div
                        style="position: relative; width: 28px; height: 28px;"
                        (mouseenter)="showVoiceVolumeSlider(attachment)"
                        (mouseleave)="hideVoiceVolumeSlider(attachment)"
                      >
                        <button mat-icon-button type="button" (click)="toggleVoiceMute(attachment, $event, voiceAudio)" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; color: #4a6583; background: rgba(235, 243, 252, 0.75); border-radius: 999px;">
                          <mat-icon style="font-size: 16px; width: 16px; height: 16px;">{{ voiceVolumeIcon(attachment) }}</mat-icon>
                        </button>
                        <div *ngIf="isVoiceVolumeSliderVisible(attachment)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" style="position: absolute; left: 50%; bottom: 30px; transform: translateX(-50%); width: 24px; height: 92px; display: flex; align-items: center; justify-content: center; border: 1px solid #d5e2f1; border-radius: 999px; background: linear-gradient(180deg, #ffffff, #edf4fe); box-shadow: 0 2px 8px rgba(33, 58, 88, 0.18); z-index: 3;">
                          <input
                            type="range"
                            min="0"
                            max="100"
                            step="1"
                            [value]="voiceVolumePercent(attachment)"
                            (input)="setVoiceVolume(attachment, $any($event.target).value, $event, voiceAudio)"
                            (click)="$event.stopPropagation()"
                            (pointerdown)="$event.stopPropagation()"
                            style="width: 72px; height: 18px; accent-color: #4d7eb8; transform: rotate(-90deg);"
                            aria-label="Voice note volume"
                          />
                        </div>
                      </div>
                      <button mat-icon-button type="button" [matMenuTriggerFor]="voiceAttachmentMenu" (menuOpened)="openVoiceAttachmentMenuFor(attachment)" (click)="$event.stopPropagation()" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; color: #4a6583; background: rgba(235, 243, 252, 0.75); border-radius: 999px;">
                        <mat-icon style="font-size: 17px; width: 17px; height: 17px;">more_vert</mat-icon>
                      </button>
                    </div>
                    <div style="font-size: 0.72rem; color: #4f6884; margin-top: 6px; padding-left: 3px;">{{ audioAttachmentLabel(attachment) }} • {{ voiceDurationLabel(attachment) }} • {{ attachmentSizeLabel(attachment.size) }}<ng-container *ngIf="voiceInsightsLabel(attachment) as voiceInfo"> • {{ voiceInfo }}</ng-container><ng-container *ngIf="isVoiceOfflineCached(attachment)"> • offline</ng-container></div>
                  </div>
                  </ng-container>
                  <div *ngIf="!isAudioAttachment(attachment)" style="border: 1px solid #d9e2ef; border-radius: 10px; padding: 7px 9px; background: #f8fbff; color: #35506c;">
                    <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
                      <div style="min-width: 0;">
                        <strong style="display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ attachment.name }}</strong>
                        <div style="font-size: 0.74rem; opacity: 0.8;">{{ attachmentTypeLabel(attachment) }} • {{ attachmentSizeLabel(attachment.size) }}</div>
                      </div>
                      <button mat-icon-button type="button" [matMenuTriggerFor]="attachmentMenu" (menuOpened)="openAttachmentMenuFor(attachment)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                    </div>
                    <iframe
                      *ngIf="isTextAttachment(attachment)"
                      [src]="attachmentUrl(attachment)"
                      title="Text preview"
                      style="width: 100%; height: 130px; border: 1px solid #d9e2ef; border-radius: 10px; background: #fff; margin-top: 6px;"
                    ></iframe>
                  </div>
                </div>
              </ng-container>
              <div
                class="text"
                *ngIf="messageBodyText(m) || m.deletedAt"
                [class.deletedText]="m.deletedAt"
                [innerHTML]="m.deletedAt ? 'Message deleted' : messageTextHtml(m)"
                (click)="onMessageTextClick(m, $event)"
              ></div>
              <ng-container *ngIf="!m.deletedAt && videoLinkPreviews(m) as videoLinks">
                <div *ngIf="videoLinks.length" style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
                  <div
                    *ngFor="let link of videoLinks; let i = index"
                    (mouseenter)="onVideoLinkCardHover(m, link, true)"
                    (mouseleave)="onVideoLinkCardHover(m, link, false)"
                    [style.transform]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'translateY(-2px) scale(1.005)' : 'none'"
                    [style.boxShadow]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? '0 16px 34px rgba(2, 10, 22, 0.34), 0 0 0 1px rgba(137, 179, 227, 0.36)' : '0 10px 24px rgba(3, 12, 23, 0.28)'"
                    [style.animation]="videoLinkMotionIntensity === 'full' ? 'messagePop 320ms cubic-bezier(0.2, 0.8, 0.2, 1)' : 'none'"
                    style="position: relative; border-radius: 16px; padding: 1px; background: linear-gradient(128deg, rgba(103, 158, 225, 0.76), rgba(35, 88, 153, 0.54) 52%, rgba(39, 141, 194, 0.48)); transition: transform 220ms ease, box-shadow 220ms ease;"
                  >
                    <div style="position: relative; overflow: hidden; border-radius: 15px; padding: 8px; background: linear-gradient(180deg, rgba(8, 20, 37, 0.95), rgba(6, 14, 26, 0.98)); backdrop-filter: blur(1px);">
                      <span [style.opacity]="isVideoLinkCardHovered(m, link) ? '0.9' : '0.6'" style="position: absolute; left: -18%; top: -40%; width: 60%; height: 90%; border-radius: 999px; background: radial-gradient(circle, rgba(118, 181, 255, 0.42), transparent 68%); filter: blur(18px); pointer-events: none; transition: opacity 200ms ease;"></span>
                      <span [style.opacity]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? '0.28' : '0.12'" [style.animation]="videoLinkMotionIntensity === 'full' ? 'shimmer 3.4s linear infinite' : 'none'" style="position: absolute; inset: 0; pointer-events: none; background: linear-gradient(110deg, rgba(255,255,255,0) 26%, rgba(188,220,255,0.3) 48%, rgba(255,255,255,0) 70%); background-size: 220% 100%;"></span>

                      <div style="position: relative; z-index: 1; display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 8px;">
                        <div style="display: inline-flex; align-items: center; gap: 6px; min-width: 0;">
                          <span [ngStyle]="videoLinkProviderChipStyle(link)" style="display: inline-flex; align-items: center; height: 21px; border-radius: 999px; padding: 0 9px; font-size: 0.63rem; font-weight: 700; letter-spacing: 0.04em; text-transform: uppercase;">{{ link.providerLabel }}</span>
                          <span style="font-size: 0.63rem; color: #a9c7e8;">inline preview</span>
                        </div>
                        <div
                          [style.opacity]="videoLinkActionBarVisible(m, link) ? '1' : '0.02'"
                          [style.transform]="videoLinkActionBarVisible(m, link) ? 'translateY(0)' : 'translateY(-6px)'"
                          [style.pointerEvents]="videoLinkActionBarVisible(m, link) ? 'auto' : 'none'"
                          class="videoLinkActionBar"
                          style="display: inline-flex; align-items: center; gap: 4px; transition: opacity 180ms ease, transform 220ms ease;"
                        >
                          <a class="videoLinkActionLink" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; text-decoration: none;" [href]="link.sourceUrl" target="_blank" rel="noopener" matTooltip="Open in new tab" (click)="$event.stopPropagation()">
                            <mat-icon>open_in_new</mat-icon>
                          </a>
                          <button type="button" class="videoLinkActionBtn" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; cursor: pointer;" (click)="toggleVideoLinkInline(m, link, $event)" [matTooltip]="videoLinkToggleLabel(m, link)">
                            <mat-icon>{{ isVideoLinkInChatOpen(m, link) ? 'expand_less' : 'expand_more' }}</mat-icon>
                          </button>
                          <button type="button" class="videoLinkActionBtn" style="width: 29px; height: 29px; min-width: 29px; border-radius: 8px; border: 1px solid rgba(173, 205, 236, 0.42); color: #e8f4ff; background: rgba(18, 36, 58, 0.56); display: inline-flex; align-items: center; justify-content: center; padding: 0; line-height: 1; cursor: pointer;" [matMenuTriggerFor]="videoLinkMoreMenuPrivate" (click)="$event.stopPropagation()" matTooltip="More actions">
                            <mat-icon>more_horiz</mat-icon>
                          </button>
                          <mat-menu #videoLinkMoreMenuPrivate="matMenu" xPosition="before">
                            <button mat-menu-item type="button" (click)="copyVideoLink(link)">
                              <mat-icon>content_copy</mat-icon>
                              <span>Copy link</span>
                            </button>
                            <button mat-menu-item type="button" (click)="shareVideoLink(link)">
                              <mat-icon>ios_share</mat-icon>
                              <span>Share link</span>
                            </button>
                            <button mat-menu-item type="button" (click)="toggleWatchPartyFromLink(m, link)" [matTooltip]="watchPartyToggleLabel(link)">
                              <mat-icon>{{ isWatchPartyForLink(link) ? 'groups' : 'group_add' }}</mat-icon>
                              <span>{{ watchPartyToggleLabel(link) }}</span>
                            </button>
                          </mat-menu>
                        </div>
                      </div>

                      <div style="position: relative; z-index: 1; margin: -2px 0 8px; display: flex; flex-direction: column; gap: 2px;">
                        <strong style="font-size: 0.74rem; color: #f2f8ff; line-height: 1.25; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ videoLinkMetaTitle(link) }}</strong>
                        <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap; font-size: 0.65rem; color: #b3cee8;">
                          <span style="max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ videoLinkMetaSubtitle(link) }}</span>
                          <span *ngIf="videoLinkMetaDurationLabel(link) as metaDuration" style="border-radius: 999px; padding: 1px 7px; background: rgba(133, 173, 215, 0.18); border: 1px solid rgba(148, 187, 226, 0.26);">{{ metaDuration }}</span>
                          <span *ngIf="videoLinkStartLabel(link) as startLabel" style="border-radius: 999px; padding: 1px 7px; background: rgba(133, 173, 215, 0.18); border: 1px solid rgba(148, 187, 226, 0.26);">starts {{ startLabel }}</span>
                        </div>
                      </div>

                      <div style="position: relative; z-index: 1; border-radius: 12px; overflow: hidden; border: 1px solid rgba(163, 194, 229, 0.42); background: #0a1019; box-shadow: inset 0 1px 0 rgba(255,255,255,0.06);">
                        <button
                          *ngIf="!isVideoLinkInChatOpen(m, link)"
                          type="button"
                          (click)="openVideoLinkInChat(m, link, $event)"
                          [style.transform]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'scale(1.015)' : 'scale(1)'"
                          style="position: relative; width: min(360px, 72vw); max-width: 100%; padding-top: 56.25%; display: block; border: 0; margin: 0; background: transparent; cursor: pointer; transition: transform 240ms ease;"
                        >
                          <span [style.background]="videoLinkHeroBackground(link)" style="position: absolute; inset: 0; display: block;"></span>
                          <span style="position: absolute; inset: 0; background: linear-gradient(180deg, rgba(9, 16, 26, 0.2), rgba(9, 16, 26, 0.68));"></span>
                          <span [style.animation]="videoLinkMotionIntensity === 'full' ? 'shimmer 2.9s linear infinite' : 'none'" style="position: absolute; inset: 0; pointer-events: none; background: linear-gradient(120deg, rgba(255,255,255,0) 22%, rgba(255,255,255,0.22) 48%, rgba(255,255,255,0) 72%); background-size: 200% 100%;"></span>
                          <span [style.animation]="videoLinkMotionIntensity === 'full' && isVideoLinkCardHovered(m, link) ? 'glowPulse 1.9s ease-in-out infinite' : 'none'" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; border-radius: 999px; border: 1px solid rgba(239, 247, 255, 0.54); background: rgba(8, 16, 28, 0.54); color: #f6fbff; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 6px 16px rgba(0,0,0,0.3);">
                            <mat-icon style="font-size: 30px; width: 30px; height: 30px; margin-left: 2px;">play_arrow</mat-icon>
                          </span>
                          <span style="position: absolute; left: 10px; bottom: 10px; color: #f3f9ff; font-size: 0.66rem; letter-spacing: 0.04em; text-transform: uppercase; font-weight: 700; text-shadow: 0 1px 3px rgba(0,0,0,0.4);">{{ link.providerLabel }} preview</span>
                        </button>

                        <div
                          *ngIf="isVideoLinkInChatOpen(m, link)"
                          [attr.data-inline-player-key]="videoLinkDomKey(m, link)"
                          [ngStyle]="videoLinkPlayerFrameStyle(m, link)"
                          (mousedown)="$event.stopPropagation()"
                          (touchstart)="$event.stopPropagation()"
                          (click)="$event.stopPropagation()"
                          style="position: relative; width: min(360px, 72vw); max-width: 100%; padding-top: 56.25%; background: #000;"
                        >
                          <div *ngIf="isVideoLinkDocked(m, link)" style="position: absolute; left: 0; right: 0; top: 0; z-index: 2; display: flex; align-items: center; justify-content: space-between; gap: 6px; padding: 4px 6px; color: #e4f2ff; background: linear-gradient(180deg, rgba(4, 11, 20, 0.86), rgba(4, 11, 20, 0.5));">
                            <span style="font-size: 0.62rem; letter-spacing: 0.04em; text-transform: uppercase; opacity: 0.86;">Docked player</span>
                            <div style="display: inline-flex; gap: 4px;">
                              <button mat-icon-button type="button" (click)="toggleVideoLinkInline(m, link, $event)" style="width: 20px; height: 20px; min-width: 20px; color: #eef8ff;">
                                <mat-icon style="font-size: 14px; width: 14px; height: 14px;">close</mat-icon>
                              </button>
                            </div>
                          </div>
                          <iframe
                            [src]="videoLinkEmbedUrl(m, link)"
                            title="In-chat video player"
                            allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
                            allowfullscreen
                            referrerpolicy="strict-origin-when-cross-origin"
                            style="position: absolute; inset: 0; width: 100%; height: 100%; border: 0;"
                          ></iframe>
                          <span style="position: absolute; inset: 0; pointer-events: none; box-shadow: inset 0 0 0 1px rgba(176, 208, 241, 0.26);"></span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </ng-container>
            </ng-template>
            <div class="meta">
              <div class="messageActions" *ngIf="!isEditingMessage(m, 'private') && !m.deletedAt">
                <button class="actionBtn" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); replyToMessage(m, 'private')" matTooltip="Reply">
                  <mat-icon>reply</mat-icon>
                </button>
                <button class="actionBtn" type="button" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); openForwardDialog(m, 'private')" matTooltip="Forward">
                  <mat-icon>forward</mat-icon>
                </button>
                <button class="actionBtn" type="button" *ngIf="canEditMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); editMessage(m, 'private')" matTooltip="Edit">
                  <mat-icon>edit</mat-icon>
                </button>
                <button class="actionBtn danger" type="button" *ngIf="canManageMessage(m)" (mousedown)="$event.stopPropagation()" (touchstart)="$event.stopPropagation()" (click)="$event.stopPropagation(); deleteMessage(m, 'private')" matTooltip="Delete">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
              <div class="metaInfo">
                <span class="editedTag" *ngIf="m.editedAt && !m.deletedAt">edited</span>
                <span class="editedTag" *ngIf="audioPlaybackReceiptLabel(m) as audioReceipt">{{ audioReceipt }}</span>
                <span class="time" *ngIf="m.timestamp">{{ m.timestamp | date:'shortTime' }}</span>
                <mat-icon *ngIf="m.from === myUsername" class="status-icon"
                          [ngClass]="m.status">
                  {{ m.status === 'sent' ? 'done' : 'done_all' }}
                </mat-icon>
              </div>
            </div>
            <div class="reactionsSummary" *ngIf="visibleReactions(m).length">
              <span class="reactionPill" *ngFor="let r of visibleReactions(m)">
                {{ r.emoji }} {{ r.users.length }}
              </span>
            </div>
            <div class="reactionPicker" *ngIf="isReactionPickerOpen(m, 'private')" (click)="$event.stopPropagation()">
              <button
                class="reactionOption"
                type="button"
                *ngFor="let emoji of messageReactions"
                [class.active]="hasReactionByMe(m, emoji)"
                (click)="toggleReaction(m, 'private', emoji)"
              >
                {{ emoji }}
                <span *ngIf="reactionCount(m, emoji)">{{ reactionCount(m, emoji) }}</span>
              </button>
            </div>
          </mat-card>
        </div>
        </ng-container>
      </ng-template>
    </div>
    </div>

    <div *ngIf="privateMediaTimelineOpen && selectedUser" style="position: absolute; left: 12px; right: 12px; top: 66px; z-index: 3; display: flex; align-items: center; gap: 8px; padding: 6px 8px; border: 1px solid #d6e2f2; border-radius: 10px; background: rgba(247, 251, 255, 0.97); box-shadow: 0 8px 18px rgba(29, 52, 81, 0.14); backdrop-filter: blur(2px); transition: transform 0.22s ease, opacity 0.22s ease;" [style.opacity]="privateMediaTimelineCollapsed ? '0.88' : '1'" [style.transform]="privateMediaTimelineCollapsed ? 'translateY(-2px)' : 'translateY(0)'">
      <strong style="font-size: 0.74rem; color: #385672; white-space: nowrap;">Media timeline</strong>
      <span style="font-size: 0.68rem; color: #5a7492; min-width: 24px; text-align: center;">{{ privateMediaTimelineCount() }}</span>
      <div style="display: inline-flex; gap: 4px;">
        <button mat-stroked-button type="button" style="height: 26px; min-width: 44px;" (click)="privateMediaTimelineFilter = 'all'">All</button>
        <button mat-stroked-button type="button" style="height: 26px; min-width: 56px;" (click)="privateMediaTimelineFilter = 'image'">Images</button>
        <button mat-stroked-button type="button" style="height: 26px; min-width: 56px;" (click)="privateMediaTimelineFilter = 'video'">Videos</button>
      </div>
      <button mat-icon-button type="button" class="timelineIconBtn" *ngIf="privateMediaTimelineFilter !== 'all'" (click)="clearPrivateMediaTimelineFilter()" matTooltip="Clear filter" aria-label="Clear timeline filter" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;">
        <mat-icon style="width: 18px; height: 18px; font-size: 18px;">filter_alt_off</mat-icon>
      </button>
      <button mat-icon-button type="button" class="timelineIconBtn" (click)="togglePrivateMediaTimelineCollapse()" matTooltip="Collapse/expand" aria-label="Collapse or expand timeline" style="width: 32px; height: 32px; display: inline-flex; align-items: center; justify-content: center;">
        <mat-icon style="width: 18px; height: 18px; font-size: 18px;">{{ privateMediaTimelineCollapsed ? 'expand_more' : 'expand_less' }}</mat-icon>
      </button>
      <ng-container *ngIf="privateMediaTimelineItems() as timelineItems">
        <div *ngIf="!privateMediaTimelineCollapsed && timelineItems.length; else emptyTimelineStateFloating" style="display: flex; gap: 7px; overflow-x: auto; margin-left: auto; max-width: min(62vw, 760px); padding: 2px 0; touch-action: pan-x;">
          <button
            type="button"
            data-timeline-thumb="true"
            *ngFor="let item of timelineItems.slice(0, 30); trackBy: trackByTimelineItem"
            (pointerdown)="onTimelineThumbPointerDown(item, $event)"
            (pointerup)="onTimelineThumbPointerUp(item, $event)"
            (pointercancel)="clearTimelineThumbPointerState()"
            (pointerleave)="clearTimelineThumbPointerState()"
            (click)="onTimelineThumbClick(item, $event)"
            style="position: relative; border: 1px solid #d3dfef; border-radius: 9px; padding: 0; background: #fff; cursor: pointer; flex: 0 0 auto; overflow: hidden; box-shadow: 0 1px 3px rgba(20, 41, 66, 0.1); min-width: 52px; min-height: 52px; touch-action: pan-x;"
            tabindex="0"
            [attr.aria-label]="'Open timeline media ' + (item.attachment.name || 'attachment')"
          >
            <img *ngIf="isImageAttachment(item.attachment)" [src]="attachmentUrl(item.attachment)" [alt]="item.attachment.name" style="width: 52px; height: 52px; object-fit: cover; display: block; pointer-events: none;" />
            <video *ngIf="isVideoAttachment(item.attachment)" [src]="attachmentUrl(item.attachment)" muted playsinline preload="metadata" (loadedmetadata)="onTimelineThumbVideoMetadata($event)" style="width: 52px; height: 52px; object-fit: cover; display: block; background: #000; pointer-events: none;"></video>
            <div *ngIf="isVideoAttachment(item.attachment)" style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 18px; height: 18px; border-radius: 999px; background: rgba(12, 21, 34, 0.7); color: #fff; display: flex; align-items: center; justify-content: center; pointer-events: none;">
              <mat-icon style="font-size: 12px; width: 12px; height: 12px;">play_arrow</mat-icon>
            </div>
          </button>
        </div>
      </ng-container>
      <ng-template #emptyTimelineStateFloating>
        <div style="margin-left: auto; font-size: 0.73rem; color: #5f7894; display: inline-flex; align-items: center; gap: 8px;">
          {{ privateMediaTimelineCollapsed ? 'Timeline collapsed' : 'No media for this filter' }}
        </div>
      </ng-template>
    </div>

    <mat-menu #searchPresetMenu="matMenu" panelClass="searchPresetMenuPanel">
      <button mat-menu-item type="button" (click)="toggleSearchFilterTokenFromMenu('has:media')">
        <mat-icon>{{ hasSearchFilterToken('has:media') ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <mat-icon>photo_library</mat-icon>
        <span>Has media</span>
      </button>
      <button mat-menu-item type="button" (click)="toggleSearchFilterTokenFromMenu('type:image')">
        <mat-icon>{{ hasSearchFilterToken('type:image') ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <mat-icon>image</mat-icon>
        <span>Images only</span>
      </button>
      <button mat-menu-item type="button" (click)="toggleSearchFilterTokenFromMenu('type:video')">
        <mat-icon>{{ hasSearchFilterToken('type:video') ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <mat-icon>videocam</mat-icon>
        <span>Videos only</span>
      </button>
      <button mat-menu-item type="button" (click)="toggleSearchFilterTokenFromMenu('has:attachment')">
        <mat-icon>{{ hasSearchFilterToken('has:attachment') ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <mat-icon>attach_file</mat-icon>
        <span>Has attachment</span>
      </button>
      <button mat-menu-item type="button" (click)="toggleSearchFilterTokenFromMenu('from:' + selectedUser)" *ngIf="selectedUser">
        <mat-icon>{{ hasSearchFilterToken('from:' + selectedUser) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <mat-icon>person</mat-icon>
        <span>From {{ selectedUser }}</span>
      </button>
      <button mat-menu-item type="button" (click)="resetSearchFilters()" *ngIf="searchFilterCount()">
        <mat-icon>filter_alt_off</mat-icon>
        <span>Reset filters</span>
      </button>
    </mat-menu>

    <!-- Menu for public usernames -->
    <mat-menu #userMenu="matMenu">
      <button mat-menu-item (click)="openUserProfileCard(menuUser)">
        <mat-icon>badge</mat-icon>
        <span>View profile</span>
      </button>
      <button mat-menu-item (click)="startChatFromPublic(menuUser, false)">
        <mat-icon>chat</mat-icon>
        <span>Open private chat</span>
      </button>
      <button mat-menu-item (click)="startChatFromPublic(menuUser, true)">
        <mat-icon>reply</mat-icon>
        <span>Reply message privatly</span>
      </button>
    </mat-menu>

    <mat-menu #attachmentMenu="matMenu">
      <button mat-menu-item type="button" (click)="downloadAttachment(attachmentMenuTarget)">
        <mat-icon>download</mat-icon>
        <span>Download</span>
      </button>
      <button mat-menu-item type="button" *ngIf="canOpenInGoogleDocs(attachmentMenuTarget)" (click)="openAttachmentInGoogleDocs(attachmentMenuTarget)">
        <mat-icon>description</mat-icon>
        <span>Open in Google Docs</span>
      </button>
    </mat-menu>

    <mat-menu #voiceAttachmentMenu="matMenu">
      <button mat-menu-item type="button" (click)="downloadAttachment(voiceMenuTarget)">
        <mat-icon>download</mat-icon>
        <span>Download</span>
      </button>
      <button mat-menu-item type="button" (click)="setVoicePlaybackRate(voiceMenuTarget, 1)">
        <mat-icon>{{ voicePlaybackRate(voiceMenuTarget) === 1 ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <span>Speed 1x</span>
      </button>
      <button mat-menu-item type="button" (click)="setVoicePlaybackRate(voiceMenuTarget, 1.5)">
        <mat-icon>{{ voicePlaybackRate(voiceMenuTarget) === 1.5 ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <span>Speed 1.5x</span>
      </button>
      <button mat-menu-item type="button" (click)="setVoicePlaybackRate(voiceMenuTarget, 2)">
        <mat-icon>{{ voicePlaybackRate(voiceMenuTarget) === 2 ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
        <span>Speed 2x</span>
      </button>
      <button mat-menu-item type="button" (click)="zoomOutVoiceWaveform(voiceMenuTarget)">
        <mat-icon>remove</mat-icon>
        <span>Waveform zoom out</span>
      </button>
      <button mat-menu-item type="button" (click)="zoomInVoiceWaveform(voiceMenuTarget)">
        <mat-icon>add</mat-icon>
        <span>Waveform zoom in</span>
      </button>
    </mat-menu>

    <!-- Composer -->
    <form class="composer" (ngSubmit)="selectedUser ? sendPrivate() : sendPublic()">
      <div class="composerFieldWrap">
        <input #attachmentInput type="file" multiple hidden (change)="onAttachmentSelected($event)" />
        <div class="composerReply" *ngIf="replyingTo">
          <div class="composerReplyText">
            <strong>Replying to {{ replyAuthorLabel(replyingTo.from) }}</strong>
            <span>{{ replyPreviewText(replyingTo.text, replyingTo.attachment, replyingTo.attachments) }}</span>
            <span *ngIf="referenceMetaLabel(replyingTo) as replyingMeta">{{ replyingMeta }}</span>
            <img *ngIf="isImageAttachment(replyingTo.attachment)" [src]="attachmentUrl(replyingTo.attachment)" [alt]="replyingTo.attachment?.name" loading="lazy" style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef;" />
            <video *ngIf="isVideoAttachment(replyingTo.attachment)" [src]="attachmentUrl(replyingTo.attachment)" preload="metadata" (loadedmetadata)="onVideoPreviewMetadata($event, replyingTo.attachment)" muted playsinline [attr.autoplay]="autoplayMediaPreviews ? '' : null" loop style="margin-top: 4px; max-width: 84px; max-height: 52px; border-radius: 6px; border: 1px solid #d9e2ef; background: #000;"></video>
            <span *ngIf="replyingTo.attachment">{{ attachmentTypeLabel(replyingTo.attachment) }} • {{ replyingTo.attachment.name }}</span>
            <span *ngIf="referenceAttachmentCount(replyingTo) > 1">+{{ referenceAttachmentCount(replyingTo) - 1 }} more attachments</span>
          </div>
          <button mat-icon-button type="button" (click)="clearReplyTarget()" matTooltip="Cancel reply">
            <mat-icon>close</mat-icon>
          </button>
        </div>
        <div *ngIf="pendingAttachments.length" style="background: #f4f7fc; border: 1px solid #d8e1ee; border-radius: 10px; padding: 6px 8px; margin-bottom: 6px;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <strong style="font-size: 0.76rem; color: #355170;">{{ compactPendingTitle() }}</strong>
            <div style="display: flex; align-items: center; gap: 4px;">
              <button mat-icon-button type="button" (click)="showPendingAttachmentsPanel = !showPendingAttachmentsPanel" matTooltip="Toggle details">
                <mat-icon>{{ showPendingAttachmentsPanel ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
              <button mat-icon-button type="button" (click)="clearPendingAttachments()" matTooltip="Clear all">
                <mat-icon>delete_sweep</mat-icon>
              </button>
            </div>
          </div>
          <div *ngIf="showPendingAttachmentsPanel" style="display: flex; flex-direction: column; gap: 3px; margin-top: 4px; max-height: 88px; overflow-y: auto; overflow-x: hidden;">
            <div *ngFor="let attachment of pendingAttachments; let i = index" style="display: flex; align-items: center; justify-content: space-between; gap: 8px; min-height: 22px; width: 100%; min-width: 0; overflow: hidden;">
              <span style="font-size: 0.72rem; color: #3d5a78; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ attachment.name }}</span>
              <button mat-icon-button type="button" (click)="removePendingAttachment(i)" matTooltip="Remove">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>
        </div>
        <div *ngIf="uploadErrors.length" style="display: flex; flex-direction: column; gap: 4px; background: #fff6ef; border: 1px solid #efd7c6; border-radius: 10px; padding: 6px 8px; margin-bottom: 6px; color: #7a4a27;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <strong style="font-size: 0.78rem;">Some files were not uploaded</strong>
            <button mat-icon-button type="button" (click)="clearUploadErrors()" matTooltip="Dismiss">
              <mat-icon>close</mat-icon>
            </button>
          </div>
          <div *ngFor="let err of uploadErrors" style="font-size: 0.74rem; line-height: 1.25;">
            • {{ err }}
          </div>
          <div *ngIf="persistedFailedUploadNames.length" style="font-size: 0.7rem; color: #8c5d39; border-top: 1px dashed #e6c8b0; padding-top: 4px;">
            Previous failed files: {{ persistedFailedUploadNames.join(', ') }}
          </div>
          <div style="display: flex; gap: 8px; margin-top: 2px;">
            <button mat-stroked-button type="button" (click)="retryFailedUploads()" [disabled]="uploadingAttachment">Retry failed</button>
          </div>
        </div>
        <ng-container *ngIf="resumableUploadsList() as resumables">
        <div *ngIf="resumables.length" style="display: flex; flex-direction: column; gap: 4px; background: #eef6ff; border: 1px solid #d3e3f6; border-radius: 10px; padding: 6px 8px; margin-bottom: 6px; color: #355377;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <strong style="font-size: 0.76rem;">Resumable uploads</strong>
            <button mat-icon-button type="button" (click)="clearResumableUploadsList()" matTooltip="Clear list"><mat-icon>clear_all</mat-icon></button>
          </div>
          <div *ngFor="let resumable of resumables; let i = index; trackBy: trackByResumableItem" style="display: flex; flex-direction: column; gap: 2px; font-size: 0.72rem; line-height: 1.25; border-top: 1px dashed #d8e6f7; padding-top: 4px;" [style.borderTop]="i === 0 ? '0' : '1px dashed #d8e6f7'">
            <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
              <span style="min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                {{ i + 1 }}. {{ resumable.fileName }} - {{ resumable.uploadedChunks.length }}/{{ resumable.totalChunks }} chunks ({{ resumableProgressPercent(resumable.uploadedChunks, resumable.totalChunks) }}%)
              </span>
              <button mat-icon-button type="button" (click)="removeResumableUpload(resumable.key)" matTooltip="Dismiss" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center;">
                <mat-icon style="font-size: 16px; width: 16px; height: 16px;">close</mat-icon>
              </button>
            </div>
            <div style="height: 4px; background: #d7e7f9; border-radius: 999px; overflow: hidden;">
              <div [style.width.%]="resumableProgressPercent(resumable.uploadedChunks, resumable.totalChunks)" style="height: 100%; background: #4e79bb;"></div>
            </div>
            <span *ngIf="resumable.failedChunks.length" style="color: #6f4866;">Failed chunk(s): {{ formatChunkIndexes(resumable.failedChunks) }}</span>
          </div>
          <div style="font-size: 0.7rem; color: #5e7694;">Re-select the same file name to continue from uploaded chunks.</div>
        </div>
        </ng-container>
        <ng-container *ngIf="visibleUploadItems() as queueItems">
        <div *ngIf="queueItems.length" style="display: flex; flex-direction: column; gap: 3px; background: #f4f7fc; border: 1px solid #d8e1ee; border-radius: 10px; padding: 6px 8px; margin-bottom: 6px; color: #385878;">
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <strong style="font-size: 0.76rem;">{{ compactQueueTitle() }}</strong>
            <div style="display: flex; align-items: center; gap: 4px;">
              <button mat-icon-button type="button" (click)="showUploadQueuePanel = !showUploadQueuePanel" matTooltip="Toggle details">
                <mat-icon>{{ showUploadQueuePanel ? 'expand_more' : 'expand_less' }}</mat-icon>
              </button>
              <button mat-icon-button type="button" (click)="cancelAttachmentUploads()" *ngIf="uploadingAttachment" matTooltip="Cancel queue">
                <mat-icon>stop_circle</mat-icon>
              </button>
            </div>
          </div>
          <div *ngIf="showUploadQueuePanel" style="max-height: 88px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 2px;">
          <div *ngFor="let item of queueItems; trackBy: trackByUploadItem" style="display: flex; flex-direction: column; gap: 2px;">
            <div style="display: flex; justify-content: space-between; font-size: 0.74rem; gap: 8px; align-items: center;">
              <span style="min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ item.name }}</span>
              <div style="display: inline-flex; align-items: center; gap: 6px;">
                <span *ngIf="item.status === 'uploading'">{{ item.progress }}%</span>
                <span *ngIf="item.status === 'done'">done</span>
                <span *ngIf="item.status === 'failed'">failed</span>
                <span *ngIf="item.status === 'cancelled'">cancelled</span>
                <button mat-stroked-button type="button" *ngIf="item.status === 'failed'" (click)="retryUploadItem(item.id)" [disabled]="uploadingAttachment" style="height: 22px; min-width: 44px; line-height: 20px; padding: 0 8px;">Retry</button>
                <button mat-icon-button type="button" *ngIf="item.status !== 'uploading'" (click)="dismissUploadItem(item.id)" matTooltip="Dismiss" aria-label="Dismiss upload item" style="width: 24px; height: 24px; min-width: 24px; display: inline-flex; align-items: center; justify-content: center;">
                  <mat-icon style="font-size: 16px; width: 16px; height: 16px;">close</mat-icon>
                </button>
              </div>
            </div>
            <div *ngIf="item.status === 'uploading'" style="height: 4px; background: #dae6f8; border-radius: 999px; overflow: hidden;">
              <div [style.width.%]="item.progress" style="height: 100%; background: #4a75b8;"></div>
            </div>
          </div>
          </div>
        </div>
        </ng-container>
        <div *ngIf="voiceDraft as draft" style="display: flex; flex-direction: column; gap: 6px; margin: 0 0 8px; border: 1px solid #d6e2f2; border-radius: 12px; background: linear-gradient(180deg, #f9fcff, #f1f7ff); padding: 8px 9px;">
          <audio
            #voiceDraftAudio
            [src]="voiceDraftPreviewUrl || ''"
            preload="metadata"
            (loadedmetadata)="onVoiceDraftPreviewMetadata($event)"
            (timeupdate)="onVoiceDraftPreviewTimeUpdate($event)"
            (play)="onVoiceDraftPreviewPlay()"
            (pause)="onVoiceDraftPreviewPause()"
            (ended)="onVoiceDraftPreviewPause()"
            style="display: none;"
          ></audio>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <div style="display: inline-flex; align-items: center; gap: 7px; min-width: 0;">
              <button mat-icon-button type="button" (click)="toggleVoiceDraftPreviewPlay()" style="width: 28px; height: 28px; min-width: 28px; display: inline-flex; align-items: center; justify-content: center; border-radius: 999px; border: 1px solid #cfdff1; background: linear-gradient(180deg, #f6faff, #e6f0fc);">
                <mat-icon style="font-size: 16px; width: 16px; height: 16px; color: #365b85;">{{ voiceDraftPreviewPlayIcon() }}</mat-icon>
              </button>
              <strong style="font-size: 0.76rem; color: #355474;">Voice draft</strong>
              <span style="font-size: 0.7rem; color: #5d7491; font-variant-numeric: tabular-nums;">{{ voiceDraftPreviewCurrentLabel() }} / {{ voiceDraftTrimDurationLabel() }}</span>
            </div>
            <span style="font-size: 0.68rem; color: #5f7894; min-width: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ voiceDraftInsightsLabel() }}</span>
          </div>
          <div
            #voiceDraftTrimTrack
            (pointermove)="onVoiceDraftTrimPointerMove($event)"
            (pointerup)="finishVoiceDraftTrimDrag($event)"
            (pointercancel)="finishVoiceDraftTrimDrag($event)"
            style="position: relative; height: 30px; border-radius: 8px; overflow: hidden; border: 1px solid #d8e6f7; background: linear-gradient(180deg, #fdfefe, #edf5ff); display: flex; align-items: center; justify-content: space-between; gap: 0; padding: 0 4px; touch-action: none;"
          >
            <span *ngFor="let bar of draft.waveform; let i = index; trackBy: trackByNumber" [style.height.px]="bar" style="display: inline-block; width: 2px; border-radius: 999px; background: linear-gradient(180deg, #b4ccea, #8eb0d8);"></span>
            <span style="position: absolute; inset: 0; background: rgba(28, 44, 66, 0.14);" [style.clipPath]="'polygon(0 0, ' + voiceDraftSelectionStartPercent() + '% 0, ' + voiceDraftSelectionStartPercent() + '% 100%, 0 100%)'"></span>
            <span style="position: absolute; inset: 0; background: rgba(28, 44, 66, 0.14);" [style.clipPath]="'polygon(' + voiceDraftSelectionEndPercent() + '% 0, 100% 0, 100% 100%, ' + voiceDraftSelectionEndPercent() + '% 100%)'"></span>
            <span style="position: absolute; top: 2px; bottom: 2px; border-radius: 6px; background: rgba(71, 124, 190, 0.28); border: 1px solid rgba(64, 110, 168, 0.35);" [style.left.%]="voiceDraftSelectionStartPercent()" [style.width.%]="voiceDraftSelectionWidthPercent()"></span>
            <span style="position: absolute; top: 2px; bottom: 2px; width: 2px; border-radius: 999px; background: rgba(39, 97, 165, 0.95); box-shadow: 0 0 0 1px rgba(255,255,255,0.84), 0 0 8px rgba(54, 110, 177, 0.24); transform: translateX(-50%); pointer-events: none;" [style.left.%]="voiceDraftPreviewProgressPercent()"></span>
            <button
              type="button"
              (pointerdown)="startVoiceDraftTrimDrag('start', $event, voiceDraftTrimTrack)"
              style="position: absolute; top: 50%; width: 14px; height: 14px; border-radius: 999px; border: 1px solid #2e649f; background: #fff; box-shadow: 0 0 0 2px rgba(83, 126, 181, 0.25); transform: translate(-50%, -50%); left: 0;"
              [style.left.%]="voiceDraftSelectionStartPercent()"
              aria-label="Trim start"
            ></button>
            <button
              type="button"
              (pointerdown)="startVoiceDraftTrimDrag('end', $event, voiceDraftTrimTrack)"
              style="position: absolute; top: 50%; width: 14px; height: 14px; border-radius: 999px; border: 1px solid #2e649f; background: #fff; box-shadow: 0 0 0 2px rgba(83, 126, 181, 0.25); transform: translate(-50%, -50%); left: 100%;"
              [style.left.%]="voiceDraftSelectionEndPercent()"
              aria-label="Trim end"
            ></button>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 10px; font-size: 0.68rem; color: #55718f; font-variant-numeric: tabular-nums;">
            <span>Start {{ formatDuration(draft.trimStartSeconds) }}</span>
            <span>End {{ formatDuration(draft.trimEndSeconds) }}</span>
          </div>
          <div style="display: flex; align-items: center; justify-content: space-between; gap: 8px;">
            <button mat-stroked-button type="button" style="height: 24px; min-width: 122px;" (click)="toggleVoiceDraftNormalize()">{{ draft.normalize ? 'Normalize volume: On' : 'Normalize volume: Off' }}</button>
            <div style="display: inline-flex; gap: 6px;">
              <button mat-stroked-button type="button" style="height: 24px; min-width: 62px;" (click)="discardVoiceDraft()" [disabled]="voiceDraftProcessing">Discard</button>
              <button mat-stroked-button type="button" style="height: 24px; min-width: 78px;" (click)="rerecordVoiceDraft()" [disabled]="voiceDraftProcessing || uploadingAttachment || isRecordingVoice">Re-record</button>
              <button mat-flat-button color="primary" type="button" style="height: 24px; min-width: 86px;" (click)="commitVoiceDraft()" [disabled]="voiceDraftProcessing">{{ voiceDraftProcessing ? 'Processing...' : 'Add voice' }}</button>
            </div>
          </div>
        </div>
        <div *ngIf="isRecordingVoice" style="display: inline-flex; align-items: center; gap: 8px; margin: 0 0 6px; border: 1px solid #d7e3f3; background: #f4f8ff; color: #355271; border-radius: 999px; padding: 4px 10px; font-size: 0.74rem;">
          <span style="width: 8px; height: 8px; border-radius: 999px; background: #cc4b4b;"></span>
          Recording voice note {{ voiceRecordingLabel() }}
          <button mat-stroked-button type="button" style="height: 22px; min-width: 50px; line-height: 20px; padding: 0 8px;" (click)="stopVoiceRecording(false)">Stop</button>
        </div>
        <mat-form-field appearance="fill" class="composerInput">
          <input
            matInput
            [(ngModel)]="message"
            name="msg"
            autocomplete="off"
            [placeholder]="selectedUser ? 'Type a private message' : 'Type a public message'"
            (input)="selectedUser ? onPrivateInput() : onPublicInput()"
            (blur)="onInputBlur()"
          />
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="emojiTrigger"
            aria-label="Attach file"
            [disabled]="uploadingAttachment || isRecordingVoice"
            (click)="openAttachmentPicker(); $event.stopPropagation()"
          >
            <mat-icon>{{ uploadingAttachment ? (hourglassTop ? 'hourglass_top' : 'hourglass_bottom') : 'attach_file' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="emojiTrigger"
            [attr.aria-label]="isRecordingVoice ? 'Stop voice recording' : 'Record voice note'"
            [disabled]="uploadingAttachment"
            (click)="toggleVoiceRecording(); $event.stopPropagation()"
          >
            <mat-icon [style.color]="isRecordingVoice ? '#c74f4f' : ''">{{ isRecordingVoice ? 'stop_circle' : 'mic' }}</mat-icon>
          </button>
          <button
            mat-icon-button
            matSuffix
            type="button"
            class="emojiTrigger"
            aria-label="Open emoji picker"
            [disabled]="isRecordingVoice"
            (click)="toggleEmojiPicker(); $event.stopPropagation()"
          >
            🙂
          </button>
        </mat-form-field>
        <div class="emojiPicker" *ngIf="showEmojiPicker" (click)="$event.stopPropagation()">
          <button class="emojiBtn" type="button" *ngFor="let emoji of composerEmojis" (click)="addEmoji(emoji)">
            {{ emoji }}
          </button>
        </div>
      </div>
      <button mat-fab color="primary" type="submit" class="sendBtn">
        <mat-icon>send</mat-icon>
      </button>
    </form>

    <div
      *ngIf="imageViewerTarget"
      class="viewerPremiumOverlay"
      style="position: fixed; inset: 0; z-index: 5000; display: flex; align-items: center; justify-content: center; padding: 10px; background: radial-gradient(circle at 15% 10%, rgba(97, 156, 233, 0.22), transparent 35%), rgba(7, 14, 25, 0.88); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);"
      (click)="closeInlineViewer()"
    >
      <div class="viewerPremiumFrame" style="width: min(1040px, 96vw); max-height: calc(100vh - 16px); overflow: auto; border-radius: 16px; border: 1px solid rgba(171, 196, 227, 0.44); box-shadow: 0 24px 56px rgba(0, 0, 0, 0.4);" (click)="$event.stopPropagation()">
        <ng-container
          *ngTemplateOutlet="imageViewerTpl; context: { dialogRef: inlineViewerDialogRef }"
        ></ng-container>
      </div>
    </div>

    <div class="deleteModalBackdrop" *ngIf="deleteCandidate" (click)="cancelDelete()">
      <div class="deleteModal" (click)="$event.stopPropagation()">
        <div class="deleteModalIcon">
          <mat-icon>delete_forever</mat-icon>
        </div>
        <h3>Delete message?</h3>
        <p>This action cannot be undone.</p>
        <div class="deleteModalPreview" *ngIf="deleteCandidate.preview">
          {{ deleteCandidate.preview }}
        </div>
        <div class="deleteModalActions">
          <button mat-stroked-button type="button" (click)="cancelDelete()">Cancel</button>
          <button mat-flat-button color="warn" type="button" (click)="confirmDelete()">Delete</button>
        </div>
      </div>
    </div>

    <div
      *ngIf="isDragAttachActive"
      style="position: absolute; inset: 76px 16px 88px; border: 2px dashed #83a5cd; border-radius: 14px; background: rgba(236, 244, 255, 0.88); display: flex; align-items: center; justify-content: center; text-align: center; color: #2f4d70; font-weight: 600; z-index: 4; pointer-events: none;"
    >
      Drop file to attach
    </div>
  </mat-sidenav-content>

  <!-- RIGHT: Online users -->
  <mat-sidenav #rightSidenav [mode]="rightPaneMode" [(opened)]="rightPaneOpened" position="end" class="rightPane">
    <div class="paneHeader">
      <span class="paneTitle">People</span>
      <button mat-icon-button (click)="openAddUserDialog()" matTooltip="Start chat with any user" class="addUserBtn">
        <mat-icon>add</mat-icon>
      </button>
    </div>

    <div class="rightBody">
      <div class="userSearch">
        <mat-icon>search</mat-icon>
        <input type="text" placeholder="Search users..." [(ngModel)]="searchTerm" (input)="applyFilter()" />
      </div>

      <!-- Pinned Users Section -->
      <div class="userSection" *ngIf="filteredPinnedUsers.length > 0">
        <div class="sectionHeader">
          <mat-icon>star</mat-icon>
          <span>Pinned</span>
        </div>
        <div class="userList">
          <div class="userCard pinned" *ngFor="let u of filteredPinnedUsers" (click)="openDmFromSidebar(u)">
            <div class="userAvatar">
              <img *ngIf="avatarUrl(u); else fallbackAvatar" [src]="avatarUrl(u)" alt="avatar" />
              <ng-template #fallbackAvatar>
                <div class="avatarFallback">
                  <mat-icon>person</mat-icon>
                </div>
              </ng-template>
              <span class="statusRing" [class.online]="getUserActivityStatus(u) === 'online' || getUserActivityStatus(u) === 'typing'"></span>
            </div>
            <div class="userInfo">
              <div class="userName">
                {{ userDisplayName(u) }}
                <span class="pinIcon" (click)="$event.stopPropagation(); togglePinnedUser(u)">
                  <mat-icon>star</mat-icon>
                </span>
              </div>
              <div class="userStatus" [class.typing]="getUserActivityStatus(u) === 'typing'">
                {{ getUserActivityText(u) }}
              </div>
            </div>
            <div class="userActions">
              <button mat-icon-button (click)="$event.stopPropagation(); openDmFromSidebar(u)" matTooltip="Message">
                <mat-icon>chat_bubble_outline</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Online Users Section -->
      <div class="userSection" *ngIf="filteredOnlineNotPinned.length > 0">
        <div class="sectionHeader">
          <mat-icon>circle</mat-icon>
          <span>Online</span>
          <span class="count">{{ filteredOnlineNotPinned.length }}</span>
        </div>
        <div class="userList">
          <div class="userCard" *ngFor="let u of filteredOnlineNotPinned" (click)="openDmFromSidebar(u)">
            <div class="userAvatar">
              <img *ngIf="avatarUrl(u); else fallbackAvatar2" [src]="avatarUrl(u)" alt="avatar" />
              <ng-template #fallbackAvatar2>
                <div class="avatarFallback">
                  <mat-icon>person</mat-icon>
                </div>
              </ng-template>
              <span class="statusRing" [class.online]="getUserActivityStatus(u) === 'online' || getUserActivityStatus(u) === 'typing'"></span>
            </div>
            <div class="userInfo">
              <div class="userName">
                {{ userDisplayName(u) }}
                <span class="roleBadge" *ngIf="userRole(u) !== 'user'">{{ userRole(u) }}</span>
              </div>
              <div class="userStatus" [class.typing]="getUserActivityStatus(u) === 'typing'">
                {{ getUserActivityText(u) }}
              </div>
            </div>
            <div class="userActions">
              <button class="pinBtn" (click)="$event.stopPropagation(); togglePinnedUser(u)" matTooltip="Pin user">
                <mat-icon>star_outline</mat-icon>
              </button>
              <button mat-icon-button (click)="$event.stopPropagation(); openDmFromSidebar(u)" matTooltip="Message">
                <mat-icon>chat_bubble_outline</mat-icon>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Empty State -->
      <div class="emptyState" *ngIf="!filteredOnlineUsers.length">
        <mat-icon>people_outline</mat-icon>
        <p>No users found</p>
        <span *ngIf="searchTerm">Try a different search term</span>
        <span *ngIf="!searchTerm">No one is online right now</span>
      </div>
    </div>
  </mat-sidenav>
</mat-sidenav-container>

<!-- Add user dialog -->
<ng-template #startChatTpl let-dialogRef="dialogRef">
  <div class="dialogBody">
    <h3>Start a Private Chat</h3>

    <mat-form-field appearance="outline" class="w100">
      <mat-label>Username</mat-label>
      <input matInput [(ngModel)]="newUser" />
    </mat-form-field>

    <div class="dialogActions">
      <button mat-stroked-button (click)="dialogRef.close()">Cancel</button>
      <button mat-flat-button color="primary" (click)="startChatConfirm(dialogRef)">Start</button>
    </div>
  </div>
</ng-template>

<div class="userProfileOverlay" *ngIf="userProfileCardOpen" (click)="closeUserProfileCard()" (keydown.escape)="closeUserProfileCard()">
  <div class="userProfileCard" (click)="$event.stopPropagation()">
    <div class="preview-header">
      <div>
        <h2>Profile</h2>
        <div class="subtitle">User profile information</div>
      </div>
      <button type="button" class="ghost" (click)="closeUserProfileCard()" aria-label="Close profile card">✕</button>
    </div>
    <app-profile-preview [profile]="{
      username: userProfileCardData?.username || userProfileCardUsername,
      displayName: userProfileCardData?.displayName || userProfileCardData?.username || userProfileCardUsername,
      avatarUrl: avatarUrl(userProfileCardUsername),
      bio: userProfileCardData?.bio || '',
      statusText: userProfileCardData?.statusText || '',
      emailVerified: userProfileCardData?.emailVerified,
      gender: userProfileCardData?.gender,
      age: userProfileCardData?.age,
      country: userProfileCardData?.country,
      joinedAt: userProfileCardData?.joinedAt,
      isOnline: userProfileCardData?.isOnline,
      socialLinks: userProfileCardData?.socialLinks,
      loading: userProfileCardLoading
    }"></app-profile-preview>
  </div>
</div>

<ng-template #forwardTpl let-dialogRef="dialogRef">
  <div class="dialogBody">
    <h3>Forward Message</h3>

    <div class="confirmDeletePreview" *ngIf="forwardCandidate">
      <strong>{{ replyAuthorLabel(forwardCandidate.from) }}</strong>
      <div>{{ replyPreviewText(forwardCandidate.text, forwardCandidate.attachment, forwardCandidate.attachments) }}</div>
      <div *ngIf="referenceMetaLabel(forwardCandidate) as forwardMeta">{{ forwardMeta }}</div>
    </div>

    <mat-form-field appearance="outline" class="w100">
      <mat-label>Search recipients</mat-label>
      <input matInput [(ngModel)]="forwardSearchTerm" />
    </mat-form-field>

    <mat-selection-list [(ngModel)]="forwardSelectedUsers" [multiple]="true" style="max-height: 180px; overflow: auto; border: 1px solid #dbe4f0; border-radius: 10px; margin-bottom: 10px;">
      <mat-list-option *ngFor="let u of forwardRecipientOptions()" [value]="u">
        {{ u }}
      </mat-list-option>
    </mat-selection-list>

    <p class="muted" style="margin: 0 0 10px; text-align: left;">{{ forwardRecipientsLabel() }}</p>

    <mat-form-field appearance="outline" class="w100">
      <mat-label>Add note (optional)</mat-label>
      <textarea matInput rows="2" [(ngModel)]="forwardNote"></textarea>
    </mat-form-field>

    <div class="dialogActions">
      <button mat-stroked-button type="button" (click)="dialogRef.close()">Cancel</button>
      <button mat-flat-button color="primary" type="button" (click)="confirmForward(dialogRef)">Forward</button>
    </div>
  </div>
</ng-template>

<ng-template #imageViewerTpl let-dialogRef="dialogRef">
  <div *ngIf="imageViewerTarget as viewer" class="viewerPremiumShell" style="background: linear-gradient(180deg, #f8fbff, #f3f8ff); border-radius: 14px; overflow: hidden;">
    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid #d9e5f5;">
      <div style="display: flex; flex-direction: column; gap: 2px; min-width: 0;">
        <strong style="font-size: 0.9rem; color: #264363; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ viewerCurrentAttachment()?.name }}</strong>
        <span style="font-size: 0.75rem; color: #4c6580;">Sent by {{ replyAuthorLabel(viewer.message.from) }} • {{ formatDate(viewer.message.timestamp) }}</span>
        <span style="font-size: 0.72rem; color: #5b7390;">{{ attachmentSizeLabel(viewerCurrentAttachment()?.size) }} • {{ viewerCurrentAttachment()?.mimeType }}<ng-container *ngIf="isVideoAttachment(viewerCurrentAttachment())"> • {{ attachmentDurationLabel(viewerCurrentAttachment()) }}</ng-container></span>
        <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-top: 2px;">
          <span *ngFor="let chip of viewerMetadataChips()" style="font-size: 0.66rem; color: #365674; background: #ecf3fd; border: 1px solid #d2e1f4; border-radius: 999px; padding: 1px 7px;">{{ chip }}</span>
        </div>
      </div>
      <div style="display: flex; align-items: center; gap: 4px;">
        <button mat-icon-button type="button" (click)="showViewerShortcutHints = !showViewerShortcutHints" matTooltip="Shortcuts">
          <mat-icon>keyboard</mat-icon>
        </button>
        <button
          *ngIf="isImageAttachment(viewerCurrentAttachment()) && !viewerZoomControlOpen"
          mat-icon-button
          type="button"
          (click)="toggleViewerZoomControl()"
          [matTooltip]="viewerZoom > 1 ? 'Reset zoom' : 'Zoom'"
          style="background: rgba(42, 60, 86, 0.08);"
        >
          <mat-icon>zoom_in</mat-icon>
        </button>
        <div *ngIf="isImageAttachment(viewerCurrentAttachment()) && viewerZoomControlOpen" style="display: inline-flex; align-items: center; gap: 10px; min-height: 34px; padding: 4px 10px 4px 8px; border-radius: 999px; background: linear-gradient(180deg, #1f3552, #162940); color: #f5fbff; border: 1px solid rgba(193, 214, 241, 0.3); box-shadow: inset 0 1px 0 rgba(255,255,255,0.09), 0 2px 8px rgba(9, 21, 37, 0.24);">
          <button
            mat-icon-button
            type="button"
            (click)="viewerZoomReset()"
            matTooltip="Reset zoom"
            style="width: 22px; height: 22px; min-width: 22px; padding: 0; display: inline-flex; align-items: center; justify-content: center; color: #f5fbff; margin-right: -2px;"
          >
            <mat-icon style="font-size: 16px; width: 16px; height: 16px; opacity: 0.95;">search</mat-icon>
          </button>
          <button
            mat-icon-button
            type="button"
            (click)="viewerZoomOut()"
            matTooltip="Zoom out"
            style="width: 22px; height: 22px; min-width: 22px; padding: 0; display: inline-flex; align-items: center; justify-content: center; color: #f5fbff;"
          >
            <mat-icon style="font-size: 15px; width: 15px; height: 15px; opacity: 0.95;">remove</mat-icon>
          </button>
          <input
            type="range"
            min="1"
            max="4"
            step="0.1"
            [value]="viewerZoom"
            (input)="onViewerZoomSliderInput($any($event.target).value)"
            style="width: 108px; accent-color: #e3f0ff;"
          />
          <button
            mat-icon-button
            type="button"
            (click)="viewerZoomIn()"
            matTooltip="Zoom in"
            style="width: 22px; height: 22px; min-width: 22px; padding: 0; display: inline-flex; align-items: center; justify-content: center; color: #f5fbff;"
          >
            <mat-icon style="font-size: 15px; width: 15px; height: 15px; opacity: 0.95;">add</mat-icon>
          </button>
          <span style="font-size: 0.7rem; font-weight: 600; min-width: 36px; text-align: right; letter-spacing: 0.01em;">{{ viewerZoomPercent() }}</span>
        </div>
        <button
          mat-icon-button
          type="button"
          (click)="downloadAttachment(viewerCurrentAttachment())"
          matTooltip="Download"
        >
          <mat-icon>download</mat-icon>
        </button>
        <button
          *ngIf="viewer.media.length > 1"
          mat-icon-button
          type="button"
          (click)="downloadViewerAlbumAsZip()"
          matTooltip="Download album as ZIP"
        >
          <mat-icon>folder_zip</mat-icon>
        </button>
        <a
          *ngIf="canSearchByImage(viewerCurrentAttachment())"
          mat-icon-button
          [href]="googleImageSearchUrl(viewerCurrentAttachment())"
          target="_blank"
          rel="noopener"
          matTooltip="Search Google Images"
        >
          <mat-icon>travel_explore</mat-icon>
        </a>
        <button mat-icon-button type="button" (click)="dialogRef.close()" matTooltip="Close">
          <mat-icon>close</mat-icon>
        </button>
      </div>
    </div>

    <div class="viewerStageWrap" style="padding: 12px; display: flex; justify-content: center; background: rgba(255,255,255,0.75);">
      <div
        class="viewerStageSurface"
        [ngStyle]="viewerImageStageStyle()"
        data-viewer-stage="true"
        (wheel)="onViewerImageWheel($event)"
        (dblclick)="onViewerImageDoubleClick($event)"
        (mousedown)="onViewerDragStart($event)"
        (mousemove)="onViewerDragMove($event)"
        (mouseup)="onViewerDragEnd()"
        (mouseleave)="onViewerDragEnd()"
        (touchstart)="onViewerTouchStart($event)"
        (touchmove)="onViewerTouchMove($event)"
        (touchend)="onViewerTouchEnd()"
        (touchcancel)="onViewerTouchEnd()"
      >
        <img
          *ngIf="isImageAttachment(viewerCurrentAttachment())"
          [src]="attachmentUrl(viewerCurrentAttachment())"
          [alt]="viewerCurrentAttachment()?.name"
          [ngStyle]="viewerImageStyle()"
        />
        <video
          *ngIf="isVideoAttachment(viewerCurrentAttachment())"
          [src]="attachmentUrl(viewerCurrentAttachment())"
          (loadedmetadata)="onVideoPreviewMetadata($event, viewerCurrentAttachment())"
          controls
          autoplay
          playsinline
          style="max-width: min(860px, 90vw); max-height: 60vh; display: block; background: #000;"
        ></video>
        <div *ngIf="viewerZoomHudVisible && isImageAttachment(viewerCurrentAttachment())" style="position: absolute; left: 50%; bottom: 10px; transform: translateX(-50%); background: rgba(12, 24, 39, 0.72); color: #fff; border-radius: 999px; padding: 2px 10px; font-size: 0.72rem; letter-spacing: 0.01em;">{{ viewerZoomPercent() }}</div>
        <button *ngIf="viewer.media.length > 1" mat-icon-button type="button" (click)="viewerPrev()" [disabled]="!viewerHasPrev()" style="position: absolute; left: 10px; top: 50%; transform: translateY(-50%); background: rgba(6, 14, 25, 0.48); color: #f7fbff; border: 1px solid rgba(255, 255, 255, 0.28);">
          <mat-icon>chevron_left</mat-icon>
        </button>
        <button *ngIf="viewer.media.length > 1" mat-icon-button type="button" (click)="viewerNext()" [disabled]="!viewerHasNext()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: rgba(6, 14, 25, 0.48); color: #f7fbff; border: 1px solid rgba(255, 255, 255, 0.28);">
          <mat-icon>chevron_right</mat-icon>
        </button>
      </div>
    </div>
    <div *ngIf="viewer.media.length > 1" style="padding: 2px 12px 8px; font-size: 0.74rem; color: #4c6580;">
      Item {{ viewer.index + 1 }} of {{ viewer.media.length }} • Use keyboard arrows to navigate
    </div>
    <div *ngIf="showViewerShortcutHints" style="padding: 2px 12px 8px; font-size: 0.72rem; color: #4b637f; display: flex; gap: 10px; flex-wrap: wrap;">
      <span><strong>Keys:</strong></span>
      <span><code>←/→</code> next/prev</span>
      <span><code>+</code>/<code>-</code> zoom</span>
      <span><code>0</code> reset zoom</span>
      <span><code>?</code> toggle this hint</span>
    </div>
    <div *ngIf="viewer.media.length > 1" style="padding: 0 12px 10px; display: flex; justify-content: center;">
      <div class="viewerThumbRail" style="display: flex; gap: 6px; overflow-x: auto; max-width: min(860px, 90vw); padding-bottom: 2px;">
        <button
          type="button"
          *ngFor="let media of viewer.media; let i = index"
          (click)="viewerJumpTo(i)"
          class="viewerThumbButton"
          style="position: relative; border: 0; padding: 0; background: transparent; cursor: pointer; flex: 0 0 auto;"
        >
          <img
            *ngIf="isImageAttachment(media)"
            [src]="attachmentUrl(media)"
            [alt]="media.name"
            style="width: 52px; height: 52px; object-fit: cover; border-radius: 8px; border: 2px solid;"
            [style.border-color]="viewer.index === i ? '#436eb1' : '#d3deee'"
          />
          <video
            *ngIf="isVideoAttachment(media)"
            [src]="attachmentUrl(media)"
            preload="metadata"
            muted
            playsinline
            style="width: 52px; height: 52px; object-fit: cover; border-radius: 8px; border: 2px solid; background: #000;"
            [style.border-color]="viewer.index === i ? '#436eb1' : '#d3deee'"
          ></video>
          <div *ngIf="isVideoAttachment(media)" style="position: absolute; right: 3px; bottom: 3px; background: rgba(8, 15, 25, 0.7); color: #fff; border-radius: 999px; padding: 0 4px; font-size: 0.58rem; line-height: 1.4;">
            {{ attachmentDurationLabel(media) }}
          </div>
        </button>
      </div>
    </div>

    <div style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px; padding: 10px 12px; border-top: 1px solid #d9e5f5;">
      <div style="display: flex; align-items: center; gap: 6px;">
        <button
          class="reactionOption"
          type="button"
          *ngFor="let emoji of messageReactions"
          [class.active]="hasReactionByMe(viewer.message, emoji)"
          (click)="reactFromAttachmentViewer(emoji)"
        >
          {{ emoji }}
          <span *ngIf="reactionCount(viewer.message, emoji)">{{ reactionCount(viewer.message, emoji) }}</span>
        </button>
      </div>

      <div style="display: flex; align-items: center; gap: 6px;">
        <button mat-stroked-button type="button" [disabled]="!canReplyPrivatelyToAttachment()" (click)="replyPrivatelyToAttachment(dialogRef)">
          Reply privately
        </button>
        <button mat-stroked-button type="button" [matMenuTriggerFor]="viewerReportMenu">Report</button>
      </div>
    </div>
    <div *ngIf="viewerNotice" style="padding: 8px 12px; font-size: 0.76rem; color: #35506e; border-top: 1px solid #d9e5f5; background: #f3f8ff;">
      {{ viewerNotice }}
    </div>
  </div>
  <mat-menu #viewerReportMenu="matMenu">
    <button mat-menu-item type="button" *ngFor="let reason of reportReasonOptions" (click)="reportAttachmentFromViewer(reason.key)">
      <mat-icon>flag</mat-icon>
      <span>{{ reason.label }}</span>
    </button>
  </mat-menu>
</ng-template>
