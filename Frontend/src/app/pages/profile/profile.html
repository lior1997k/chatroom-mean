<!-- Toast notifications will be implemented inline -->

<section class="profile-page" *ngIf="!loading; else loadingTpl">
  <header class="topbar">
    <div>
      <p class="eyebrow">Account center</p>
      <h1>Profile & security</h1>
    </div>
    <div class="topbar-actions">
      <button type="button" class="dark-mode-toggle" (click)="toggleTheme()" 
              [title]="currentTheme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode'"
              aria-label="Toggle dark mode">
        <span *ngIf="currentTheme === 'light'">üåô</span>
        <span *ngIf="currentTheme === 'dark'">‚òÄÔ∏è</span>
      </button>
      <button type="button" class="ghost" (click)="goToChat()">Back to chat</button>
    </div>
  </header>

  <div class="layoutGrid">
    <aside class="card profileHero">
      <div class="avatarRow">
        <div class="avatarWrap">
          <img *ngIf="avatarPreviewUrl(); else noAvatar" [src]="avatarPreviewUrl()" alt="avatar preview" class="avatarPreview" />
          <ng-template #noAvatar>
            <div class="avatarPlaceholder">No avatar</div>
          </ng-template>
          <span *ngIf="isBirthdayToday()" class="giftBadge" title="Happy birthday">üéÅ</span>
        </div>

        <div class="avatarActions">
          <label class="uploadBtn">
            Upload avatar
            <input type="file" accept="image/*" (change)="onAvatarSelected($event)" />
          </label>
          <span class="small" *ngIf="uploadingAvatar">Uploading and saving...</span>
        </div>
      </div>

      <h2>{{ displayName || me?.username }}</h2>
      <p class="username">@{{ me?.username }}</p>
      <p class="meta">{{ me?.email || 'no email' }}</p>
      
      <div class="details">
        <p class="meta">Role: <strong>{{ me?.role }}</strong> ¬∑ {{ me?.emailVerified ? 'Verified' : 'Unverified' }}</p>
        <p class="meta">Gender: <strong>{{ gender }}</strong> ¬∑ Age: <strong>{{ ageLabel() }}</strong> ({{ showAge ? 'visible' : 'hidden' }})</p>
        <p class="meta">Country: <strong>{{ countryLabel() }}</strong> ({{ showCountry ? 'visible' : 'hidden' }})</p>
        <p class="meta">Joined {{ me?.createdAt | date:'mediumDate' }}</p>
      </div>

      <span class="small">Username and birth date are fixed after creation.</span>
    </aside>

    <article class="card">
      <h2>Public profile</h2>
      <div class="formGrid">
        <label>
          <span>Display name</span>
          <input type="text" [(ngModel)]="displayName" name="displayName" maxlength="60" (ngModelChange)="onDisplayNameInput($event)" />
          <span class="small warn" *ngIf="displayNameTaken">Display name is already taken.</span>
        </label>
        <label>
          <span>Status</span>
          <input type="text" [(ngModel)]="statusText" name="statusText" maxlength="120" />
        </label>
        <label>
          <span>Gender</span>
          <select [(ngModel)]="gender" name="gender" [disabled]="genderLocked" (ngModelChange)="onGenderChange($event)">
            <option value="male">male</option>
            <option value="female">female</option>
            <option value="other">other</option>
          </select>
          <span class="small" *ngIf="genderLocked">Gender is locked after selection.</span>
        </label>
        <label>
          <span>Birth date</span>
          <input type="date" [(ngModel)]="birthDate" name="birthDate" [disabled]="birthDateLocked" />
        </label>
        <label class="full">
          <span>Bio</span>
          <textarea [(ngModel)]="bio" name="bio" rows="3" maxlength="240"></textarea>
        </label>
        <label class="switchLabel full">
          <input type="checkbox" [(ngModel)]="showCountry" name="showCountry" />
          <span>Display detected country on public profile</span>
        </label>
        <label class="switchLabel full">
          <input type="checkbox" [(ngModel)]="showAge" name="showAge" />
          <span>Display age on public profile</span>
        </label>
        <label>
          <span>Last seen visibility</span>
          <select [(ngModel)]="lastSeenVisibility" name="lastSeenVisibility">
            <option value="everyone">Everyone</option>
            <option value="contacts">Contacts</option>
            <option value="nobody">Nobody</option>
          </select>
        </label>
      </div>
      <button type="button" class="primary" [disabled]="savingProfile" (click)="saveProfile()">
        {{ savingProfile ? 'Saving...' : 'Save profile' }}
      </button>
    </article>
  </div>

  <article class="card">
    <h2>Security</h2>
    <div class="formGrid">
      <label>
        <span>Current password</span>
        <input type="password" [(ngModel)]="currentPassword" name="currentPassword" />
      </label>
      <label>
        <span>New password</span>
        <input type="password" [(ngModel)]="newPassword" name="newPassword" />
      </label>
      <label>
        <span>Confirm new password</span>
        <input type="password" [(ngModel)]="confirmPassword" name="confirmPassword" />
      </label>
    </div>
    <div class="actionRow">
      <button type="button" class="primary" [disabled]="changingPassword" (click)="changePassword()">
        {{ changingPassword ? 'Updating...' : 'Change password' }}
      </button>
      <button type="button" class="ghost" (click)="loadSessions()">Refresh sessions</button>
      <button type="button" class="danger" (click)="logoutAllDevices()">Logout all devices</button>
    </div>

    <div class="table" *ngFor="let session of sessions">
      <div>
        <strong>{{ sessionStatus(session) }}</strong>
        <div class="small">{{ session.userAgent || 'unknown device' }}</div>
        <div class="small">IP: {{ session.ip || 'unknown' }}</div>
      </div>
      <div class="small">last used: {{ session.lastUsedAt ? (session.lastUsedAt | date:'short') : 'never' }}</div>
    </div>
    <div class="small" *ngIf="!sessionsLoading && !sessions.length">No sessions found.</div>
  </article>

  <section *ngIf="isModeratorOrHigher()" class="card">
    <h2>Moderation workspace</h2>
    <p *ngIf="adminMessage" class="notice info">{{ adminMessage }}</p>

    <div class="row">
      <input type="text" [(ngModel)]="adminSearch" placeholder="Search users" />
      <select [(ngModel)]="adminUsersRole">
        <option value="">all roles</option>
        <option value="user">user</option>
        <option value="moderator">moderator</option>
        <option value="support">support</option>
        <option value="admin">admin</option>
      </select>
      <select [(ngModel)]="adminUsersVerified">
        <option value="">any verify state</option>
        <option value="true">verified</option>
        <option value="false">unverified</option>
      </select>
      <button type="button" class="ghost" (click)="loadAdminData()">Refresh</button>
    </div>

    <h3>Users</h3>
    <div class="table" *ngFor="let user of adminUsers">
      <div>
        <strong>{{ user.username }}</strong>
        <div class="small">
          {{ user.email || 'no email' }} ¬∑ role: {{ user.role }} ¬∑ state: {{ userModerationState(user) }}
        </div>
      </div>
      <div class="actions">
        <button type="button" class="ghost" (click)="verifyEmail(user)">Verify</button>
        <button type="button" class="ghost" (click)="unlockUser(user)">Unlock</button>
        <button type="button" class="ghost" (click)="revokeSessions(user)">Revoke sessions</button>
        <button type="button" class="ghost" (click)="banUserWeek(user)">Ban 1 week</button>
        <button type="button" class="danger" (click)="blockUser(user)">Block</button>
        <button type="button" class="ghost" *ngIf="userModerationState(user) !== 'active'" (click)="unblockUser(user)">Unblock</button>
        <select *ngIf="isAdmin()" [ngModel]="user.role" (ngModelChange)="setRole(user, $event)">
          <option *ngFor="let role of roleOptionsForCurrentUser()" [ngValue]="role">{{ role }}</option>
        </select>
      </div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevUsersPage()" [disabled]="usersPage <= 1">Prev</button>
      <span class="small">page {{ usersPage }} / {{ usersPages }}</span>
      <button type="button" class="ghost" (click)="nextUsersPage()" [disabled]="usersPage >= usersPages">Next</button>
    </div>

    <ng-container *ngIf="adminReports.length">
    <h3>Attachment reports</h3>
    <div class="row">
      <select [(ngModel)]="adminReportsStatus">
        <option value="">all status</option>
        <option value="pending">pending</option>
        <option value="in_review">in_review</option>
        <option value="resolved">resolved</option>
        <option value="dismissed">dismissed</option>
      </select>
      <select [(ngModel)]="adminReportsCategory">
        <option value="">all category</option>
        <option value="spam">spam</option>
        <option value="harassment">harassment</option>
        <option value="violence">violence</option>
        <option value="sexual">sexual</option>
        <option value="copyright">copyright</option>
        <option value="other">other</option>
      </select>
      <select [(ngModel)]="adminReportsScope">
        <option value="">all scope</option>
        <option value="public">public</option>
        <option value="private">private</option>
      </select>
      <select [(ngModel)]="adminReportsSeverity">
        <option value="">all severity</option>
        <option value="low">low</option>
        <option value="medium">medium</option>
        <option value="high">high</option>
      </select>
      <button type="button" class="ghost" (click)="loadAdminData()">Apply</button>
    </div>

    <div class="table" *ngFor="let report of adminReports">
      <div>
        <strong>{{ report.scope }} ¬∑ {{ report.category }}</strong>
        <div class="small">status: {{ report.status }} ¬∑ messageId: {{ report.messageId }}</div>
      </div>
      <div class="actions">
        <button type="button" class="ghost" (click)="openReportReview(report)">Review</button>
        <button type="button" class="ghost" (click)="updateReportStatus(report, 'dismissed')">Dismiss</button>
      </div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevReportsPage()" [disabled]="reportsPage <= 1">Prev</button>
      <span class="small">page {{ reportsPage }} / {{ reportsPages }}</span>
      <button type="button" class="ghost" (click)="nextReportsPage()" [disabled]="reportsPage >= reportsPages">Next</button>
    </div>
    </ng-container>

    <ng-container *ngIf="abuseEvents.length">
    <h3>Auth abuse events</h3>
    <div class="table" *ngFor="let event of abuseEvents">
      <div>
        <strong>{{ event.type }}</strong>
        <div class="small">{{ event.identifier || event.ip || '-' }} ¬∑ severity {{ event.severity }}</div>
      </div>
      <div class="small">{{ event.createdAt | date:'short' }}</div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevAbusePage()" [disabled]="abusePage <= 1">Prev</button>
      <span class="small">page {{ abusePage }} / {{ abusePages }}</span>
      <button type="button" class="ghost" (click)="nextAbusePage()" [disabled]="abusePage >= abusePages">Next</button>
    </div>
    </ng-container>

    <h3>Moderation audit actions</h3>
    <div class="table" *ngFor="let item of adminAuditActions">
      <div>
        <strong>{{ item.action }}</strong>
        <div class="small">{{ item.actorUsername }} ({{ item.actorRole }}) -> {{ item.targetType }} {{ item.targetId || '-' }}</div>
      </div>
      <div class="small">{{ item.createdAt | date:'short' }}</div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevAuditPage()" [disabled]="auditPage <= 1">Prev</button>
      <span class="small">page {{ auditPage }} / {{ auditPages }}</span>
      <button type="button" class="ghost" (click)="nextAuditPage()" [disabled]="auditPage >= auditPages">Next</button>
    </div>
  </section>

  <div class="reviewOverlay" *ngIf="reviewOpen" (click)="closeReportReview()">
    <div class="reviewModal" (click)="$event.stopPropagation()">
      <div class="reviewHeader">
        <h3>Report review</h3>
        <button type="button" class="ghost" (click)="closeReportReview()">Close</button>
      </div>

      <p class="small" *ngIf="reviewLoading">Loading report details...</p>

      <ng-container *ngIf="!reviewLoading && reviewReport">
        <p class="small">Category: {{ reviewReport.category }} ¬∑ Scope: {{ reviewReport.scope }} ¬∑ Status: {{ reviewReport.status }}</p>
        <p class="small">Reported by: {{ reviewReport.reportedBy }}</p>
        <p class="small">Message by: {{ reviewAuthor?.username || reviewMessage?.from || 'unknown' }}</p>
        <p class="small">Message text:</p>
        <div class="reviewMessageBox">{{ reviewMessage?.text || '(no text)' }}</div>

        <div class="reviewAttachments" *ngIf="reviewMessageAttachments().length; else noAttachmentsTpl">
          <h4>Attachments</h4>
          <div class="reviewAttachmentItem" *ngFor="let attachment of reviewMessageAttachments()">
            <a [href]="reviewAttachmentUrl(attachment)" target="_blank" rel="noreferrer">{{ attachment.name || attachment.url }}</a>
            <span class="small">{{ attachment.mimeType || 'file' }}</span>
          </div>
        </div>
        <ng-template #noAttachmentsTpl>
          <p class="small">No attachments on this message.</p>
        </ng-template>

        <div class="reviewActions">
          <button type="button" class="danger" (click)="reviewDeleteMessage()" [disabled]="reviewActionBusy">Delete message</button>
          <button type="button" class="ghost" (click)="reviewDismiss()" [disabled]="reviewActionBusy">Dismiss report</button>
          <button type="button" class="ghost" (click)="reviewBanUserWeek()" [disabled]="reviewActionBusy || !reviewAuthor?._id">Ban user 1 week</button>
          <button type="button" class="danger" (click)="reviewBlockUser()" [disabled]="reviewActionBusy || !reviewAuthor?._id">Block user</button>
        </div>
      </ng-container>
    </div>
  </div>
</section>

<ng-template #loadingTpl>
  <section class="profile-page">
    <header class="topbar">
      <div style="flex: 1;">
        <p class="eyebrow">Account center</p>
        <app-skeleton-loader variant="text" style="width: 250px; height: 28px; margin-top: 8px;"></app-skeleton-loader>
      </div>
      <app-skeleton-loader variant="button"></app-skeleton-loader>
    </header>

    <div class="layoutGrid">
      <aside class="card profileHero">
        <div class="avatarRow">
          <app-skeleton-loader variant="avatar"></app-skeleton-loader>
          <app-skeleton-loader variant="button"></app-skeleton-loader>
        </div>
        <app-skeleton-loader variant="text" style="width: 150px; height: 20px; margin: 16px 0;"></app-skeleton-loader>
        <app-skeleton-loader variant="text" style="width: 100px; height: 16px; margin-bottom: 16px;"></app-skeleton-loader>
        <div style="margin-top: 16px;">
          <app-skeleton-loader variant="text" style="height: 14px; margin-bottom: 8px;"></app-skeleton-loader>
          <app-skeleton-loader variant="text" style="height: 14px; margin-bottom: 8px;"></app-skeleton-loader>
          <app-skeleton-loader variant="text" style="height: 14px;"></app-skeleton-loader>
        </div>
      </aside>

      <article class="card">
        <app-skeleton-loader variant="text" style="width: 150px; height: 24px; margin-bottom: 16px;"></app-skeleton-loader>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 14px;">
          <app-skeleton-loader variant="input"></app-skeleton-loader>
          <app-skeleton-loader variant="input"></app-skeleton-loader>
          <app-skeleton-loader variant="input"></app-skeleton-loader>
          <app-skeleton-loader variant="input"></app-skeleton-loader>
        </div>
        <app-skeleton-loader variant="button" style="margin-top: 16px;"></app-skeleton-loader>
      </article>
    </div>

    <article class="card" style="margin-top: 18px;">
      <app-skeleton-loader variant="text" style="width: 150px; height: 24px; margin-bottom: 16px;"></app-skeleton-loader>
      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px;">
        <app-skeleton-loader variant="input"></app-skeleton-loader>
        <app-skeleton-loader variant="input"></app-skeleton-loader>
        <app-skeleton-loader variant="input"></app-skeleton-loader>
      </div>
      <div style="display: flex; gap: 10px; margin-top: 16px;">
        <app-skeleton-loader variant="button"></app-skeleton-loader>
        <app-skeleton-loader variant="button"></app-skeleton-loader>
        <app-skeleton-loader variant="button"></app-skeleton-loader>
      </div>
    </article>
  </section>
</ng-template>
