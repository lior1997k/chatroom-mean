<section class="profile-page" *ngIf="!loading; else loadingTpl">
  <header class="topbar">
    <h1>Profile</h1>
    <button type="button" class="ghost" (click)="goToChat()">Back to chat</button>
  </header>

  <p *ngIf="error" class="notice error">{{ error }}</p>
  <p *ngIf="success" class="notice ok">{{ success }}</p>

  <article class="card">
    <h2>Account</h2>
    <p class="meta">Role: <strong>{{ me?.role }}</strong> · Email: {{ me?.email || 'none' }} · Verified: {{ me?.emailVerified ? 'yes' : 'no' }}</p>
    <p class="meta">Joined: {{ me?.createdAt | date:'mediumDate' }} · Last login: {{ me?.lastLoginAt ? (me?.lastLoginAt | date:'short') : 'unknown' }}</p>

    <div class="avatarBlock">
      <img *ngIf="avatarPreviewUrl(); else noAvatar" [src]="avatarPreviewUrl()" alt="avatar preview" class="avatarPreview" />
      <ng-template #noAvatar>
        <div class="avatarPlaceholder">No avatar</div>
      </ng-template>
      <div class="avatarActions">
        <label class="uploadBtn">
          Upload avatar
          <input type="file" accept="image/*" (change)="onAvatarSelected($event)" />
        </label>
        <span class="small" *ngIf="uploadingAvatar">Uploading and saving...</span>
      </div>
    </div>

    <div class="row">
      <div>
        <span class="small">Username</span>
        <div><strong>{{ me?.username }}</strong></div>
      </div>
      <span class="small">Username is fixed after account creation.</span>
    </div>

    <label>
      <span>Display name</span>
      <input type="text" [(ngModel)]="displayName" name="displayName" maxlength="60" />
    </label>

    <label>
      <span>Status</span>
      <input type="text" [(ngModel)]="statusText" name="statusText" maxlength="120" />
    </label>

    <label>
      <span>Bio</span>
      <textarea [(ngModel)]="bio" name="bio" rows="3" maxlength="240"></textarea>
    </label>

    <div class="row">
      <label>
        <span>Timezone</span>
        <input type="text" [(ngModel)]="timezone" name="timezone" maxlength="64" placeholder="e.g. Europe/Berlin" />
      </label>
      <label>
        <span>Last seen visibility</span>
        <select [(ngModel)]="lastSeenVisibility" name="lastSeenVisibility">
          <option value="everyone">Everyone</option>
          <option value="contacts">Contacts</option>
          <option value="nobody">Nobody</option>
        </select>
      </label>
    </div>

    <button type="button" class="primary" [disabled]="savingProfile" (click)="saveProfile()">
      {{ savingProfile ? 'Saving...' : 'Save profile' }}
    </button>
  </article>

  <article class="card">
    <h2>Security</h2>
    <p class="meta">Change your password and manage your logged-in sessions.</p>

    <label>
      <span>Current password</span>
      <input type="password" [(ngModel)]="currentPassword" name="currentPassword" />
    </label>

    <label>
      <span>New password</span>
      <input type="password" [(ngModel)]="newPassword" name="newPassword" />
    </label>

    <label>
      <span>Confirm new password</span>
      <input type="password" [(ngModel)]="confirmPassword" name="confirmPassword" />
    </label>

    <button type="button" class="primary" [disabled]="changingPassword" (click)="changePassword()">
      {{ changingPassword ? 'Updating...' : 'Change password' }}
    </button>
    <p *ngIf="passwordMessage" class="notice info">{{ passwordMessage }}</p>

    <div class="row">
      <h3>Active sessions</h3>
      <button type="button" class="ghost" (click)="loadSessions()">Refresh sessions</button>
      <button type="button" class="danger" (click)="logoutAllDevices()">Logout all devices</button>
    </div>

    <div class="table" *ngFor="let session of sessions">
      <div>
        <strong>{{ sessionStatus(session) }}</strong>
        <div class="small">{{ session.userAgent || 'unknown device' }}</div>
        <div class="small">IP: {{ session.ip || 'unknown' }}</div>
      </div>
      <div class="small">last used: {{ session.lastUsedAt ? (session.lastUsedAt | date:'short') : 'never' }}</div>
    </div>
    <div class="small" *ngIf="!sessionsLoading && !sessions.length">No sessions found.</div>
  </article>

  <section *ngIf="isModeratorOrHigher()" class="card">
    <h2>Moderation</h2>
    <p *ngIf="adminMessage" class="notice info">{{ adminMessage }}</p>

    <div class="row">
      <input type="text" [(ngModel)]="adminSearch" placeholder="Search users" />
      <select [(ngModel)]="adminUsersRole">
        <option value="">all roles</option>
        <option value="user">user</option>
        <option value="moderator">moderator</option>
        <option value="support">support</option>
        <option value="admin">admin</option>
      </select>
      <select [(ngModel)]="adminUsersVerified">
        <option value="">any verify state</option>
        <option value="true">verified</option>
        <option value="false">unverified</option>
      </select>
      <button type="button" class="ghost" (click)="loadAdminData()">Refresh</button>
    </div>

    <h3>Users</h3>
    <div class="table" *ngFor="let user of adminUsers">
      <div>
        <strong>{{ user.username }}</strong>
        <div class="small">{{ user.email || 'no email' }} · role: {{ user.role }}</div>
      </div>
      <div class="actions">
        <button type="button" class="ghost" (click)="verifyEmail(user)">Verify</button>
        <button type="button" class="ghost" (click)="unlockUser(user)">Unlock</button>
        <button type="button" class="ghost" (click)="revokeSessions(user)">Revoke sessions</button>
        <select *ngIf="isAdmin()" [ngModel]="user.role" (ngModelChange)="setRole(user, $event)">
          <option *ngFor="let role of roleOptionsForCurrentUser()" [ngValue]="role">{{ role }}</option>
        </select>
      </div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevUsersPage()" [disabled]="usersPage <= 1">Prev</button>
      <span class="small">page {{ usersPage }} / {{ usersPages }}</span>
      <button type="button" class="ghost" (click)="nextUsersPage()" [disabled]="usersPage >= usersPages">Next</button>
    </div>

    <h3>Attachment reports</h3>
    <div class="row">
      <select [(ngModel)]="adminReportsStatus">
        <option value="">all status</option>
        <option value="pending">pending</option>
        <option value="in_review">in_review</option>
        <option value="resolved">resolved</option>
        <option value="dismissed">dismissed</option>
      </select>
      <select [(ngModel)]="adminReportsCategory">
        <option value="">all category</option>
        <option value="spam">spam</option>
        <option value="harassment">harassment</option>
        <option value="violence">violence</option>
        <option value="sexual">sexual</option>
        <option value="copyright">copyright</option>
        <option value="other">other</option>
      </select>
      <select [(ngModel)]="adminReportsScope">
        <option value="">all scope</option>
        <option value="public">public</option>
        <option value="private">private</option>
      </select>
      <select [(ngModel)]="adminReportsSeverity">
        <option value="">all severity</option>
        <option value="low">low</option>
        <option value="medium">medium</option>
        <option value="high">high</option>
      </select>
      <button type="button" class="ghost" (click)="loadAdminData()">Apply</button>
    </div>
    <div class="table" *ngFor="let report of adminReports">
      <div>
        <strong>{{ report.scope }} · {{ report.category }}</strong>
        <div class="small">status: {{ report.status }} · messageId: {{ report.messageId }}</div>
      </div>
      <div class="actions">
        <button type="button" class="ghost" (click)="loadReportDetail(report)">Detail</button>
        <button type="button" class="ghost" (click)="updateReportStatus(report, 'in_review')">Review</button>
        <button type="button" class="ghost" (click)="updateReportStatus(report, 'resolved')">Resolve</button>
        <button type="button" class="ghost" (click)="updateReportStatus(report, 'dismissed')">Dismiss</button>
        <button type="button" class="danger" (click)="removeReportedMessage(report)">Remove message</button>
      </div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevReportsPage()" [disabled]="reportsPage <= 1">Prev</button>
      <span class="small">page {{ reportsPage }} / {{ reportsPages }}</span>
      <button type="button" class="ghost" (click)="nextReportsPage()" [disabled]="reportsPage >= reportsPages">Next</button>
    </div>

    <div class="card reportDetail" *ngIf="reportDetail?.report">
      <h3>Report detail</h3>
      <div class="small">report id: {{ reportDetail.report?._id }}</div>
      <div class="small">reported by: {{ reportDetail.report?.reportedBy }}</div>
      <div class="small">reason: {{ reportDetail.report?.reason || '-' }}</div>
      <div class="small">note: {{ reportDetail.report?.note || '-' }}</div>
      <div class="small">message text: {{ reportDetail.message?.text || '-' }}</div>
    </div>

    <h3>Auth abuse events</h3>
    <div class="table" *ngFor="let event of abuseEvents">
      <div>
        <strong>{{ event.type }}</strong>
        <div class="small">{{ event.identifier || event.ip || '-' }} · severity {{ event.severity }}</div>
      </div>
      <div class="small">{{ event.createdAt | date:'short' }}</div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevAbusePage()" [disabled]="abusePage <= 1">Prev</button>
      <span class="small">page {{ abusePage }} / {{ abusePages }}</span>
      <button type="button" class="ghost" (click)="nextAbusePage()" [disabled]="abusePage >= abusePages">Next</button>
    </div>

    <h3>Moderation audit actions</h3>
    <div class="table" *ngFor="let item of adminAuditActions">
      <div>
        <strong>{{ item.action }}</strong>
        <div class="small">{{ item.actorUsername }} ({{ item.actorRole }}) -> {{ item.targetType }} {{ item.targetId || '-' }}</div>
      </div>
      <div class="small">{{ item.createdAt | date:'short' }}</div>
    </div>
    <div class="pagerRow">
      <button type="button" class="ghost" (click)="prevAuditPage()" [disabled]="auditPage <= 1">Prev</button>
      <span class="small">page {{ auditPage }} / {{ auditPages }}</span>
      <button type="button" class="ghost" (click)="nextAuditPage()" [disabled]="auditPage >= auditPages">Next</button>
    </div>
  </section>
</section>

<ng-template #loadingTpl>
  <section class="profile-page">
    <div class="card">Loading profile...</div>
  </section>
</ng-template>
